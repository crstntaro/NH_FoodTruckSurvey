<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mendokoro / Yushoken — Food Truck Survey</title>

<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --font:"Montserrat",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  --accent:#0e9ba4; 
  --accent-dk:#0c8a92;
  --ink:#101010; --muted:#6b7280; --paper:#fff; --bg:#fff; --line:#e5e7eb;
  --ease:cubic-bezier(.22,.61,.36,1); --header-h:64px;
  --coupon-red:#ff1f28; --coupon-ink:#151515;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:var(--font);color:var(--ink);background:var(--bg);
  line-height:1.6; opacity:0; transform:translateY(6px); animation:fadeIn .35s ease forwards;
}
body.lock{ overflow:hidden }
body:not(.lock){ overflow:auto }
@keyframes fadeIn{to{opacity:1;transform:none}}

/* ================== HEADER ================== */
.site-header{
  position:fixed;inset:0 0 auto 0;height:var(--header-h);display:none;align-items:center;z-index:4;
  background:#ffffffd9;border-bottom:1px solid var(--line);backdrop-filter:saturate(180%) blur(6px);opacity:0
}
.site-header.show{display:flex;animation:hdr .22s var(--ease) forwards}
@keyframes hdr{to{opacity:1}}
.nav{max-width:1200px;margin:0 auto;padding:0 16px;width:100%;display:flex;justify-content:space-between;align-items:center;height:100%}
.brand-img{height:32px}
.brand-right{text-align:right}
.brand-name{font:800 15px/1 var(--font)}
.brand-sub{font:800 11px/1 var(--font); color:var(--muted); letter-spacing:.06em; text-transform:uppercase}

/* ================== Subtle BG ================== */
.bg{position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden;
  background:radial-gradient(1200px 360px at 50% -120px, rgba(14,155,164,.10), transparent 65%);
}
.scroller{position:absolute; inset:0; width:200%; height:100%; display:flex; animation:fuji-x 90s linear infinite}
@keyframes fuji-x{from{transform:translateX(0)} to{transform:translateX(-50%)}}
.belt{position:relative; width:50%; height:100%}
.fuji{position:absolute; opacity:.08; filter:grayscale(1)}
.f1{top:4%;left:8%;width:60px;transform:rotate(-9deg)} .f2{top:9%;left:32%;width:66px;transform:rotate(8deg)}
.f3{top:2%;left:58%;width:62px;transform:rotate(-16deg)} .f4{top:8%;left:83%;width:68px;transform:rotate(12deg)}
.f5{top:24%;left:13%;width:66px;transform:rotate(6deg)} .f6{top:21%;left:46%;width:72px;transform:rotate(-14deg)}
.f7{top:23%;left:74%;width:56px;transform:rotate(14deg)} .f8{top:48%;left:9%;width:60px;transform:rotate(-7deg)}
.f9{top:44%;left:37%;width:72px;transform:rotate(18deg)} .f10{top:41%;left:63%;width:80px;transform:rotate(-20deg)}
.f11{top:46%;left:89%;width:62px;transform:rotate(10deg)} .f12{top:69%;left:16%;width:54px;transform:rotate(13deg)}
.f13{top:63%;left:42%;width:74px;transform:rotate(-9deg)} .f14{top:66%;left:69%;width:66px;transform:rotate(7deg)}
.f15{top:60%;left:93%;width:60px;transform:rotate(-15deg)} .f16{top:88%;left:27%;width:62px;transform:rotate(-8deg)}
.f17{top:86%;left:53%;width:60px;transform:rotate(16deg)} .f18{top:90%;left:80%;width:68px;transform:rotate(-5deg)}

/* subtle food plates in corners */
.food-bg{position:fixed; inset:0; pointer-events:none; z-index:0}
.food-bg img{position:absolute; user-select:none; filter:blur(1px) drop-shadow(0 18px 36px rgba(0,0,0,.12)); opacity:.22}
.food-bg .left-bowl{left:-80px; bottom:-60px; width:min(520px,70vw)}
.food-bg .right-gyoza{right:-60px; bottom:-40px; width:min(380px,55vw); transform:rotate(-6deg)}

/* ================== HERO ================== */
.hero{ position:relative; min-height:100dvh; display:grid; place-items:center; padding:28px 16px; text-align:center; overflow:hidden; }
.wrap{max-width:960px; margin:0 auto; display:grid; justify-items:center; position:relative; z-index:1}
.hero-logo{margin:0 0 10px; transform:translateY(6px) scale(.985); opacity:0; animation:logoIn .5s var(--ease) .05s forwards}
.hero-logo img{width:min(520px,78vw); height:auto; display:block; filter:drop-shadow(0 14px 24px rgba(0,0,0,.10))}
@keyframes logoIn{to{transform:none; opacity:1}}
.subtitle{font:800 clamp(13px,2.6vw,16px)/1.2 var(--font); color:var(--muted); opacity:0; transform:translateY(6px); animation:rise .45s ease .1s forwards}
.accent-underline{width:0; height:3px; margin:10px auto 0; background:linear-gradient(90deg,transparent,var(--accent),transparent); border-radius:999px; opacity:.95; animation:underline .6s ease .18s forwards}
@keyframes underline{to{width:220px}}
@keyframes rise{to{opacity:1; transform:none}}
.strap{display:inline-flex; gap:10px; align-items:center; margin:14px 0 20px; color:var(--accent); font-weight:800; font-size:12px; letter-spacing:.12em; text-transform:uppercase; padding:8px 16px; border:1px solid #cfeff3; border-radius:999px; background:#e9fbfd; opacity:0; transform:translateY(6px); animation:rise .45s ease .22s forwards}
.lead{color:#4b5563; font-size:clamp(15px,2.4vw,18px); max-width:650px; margin:0 auto 20px; opacity:0; transform:translateY(6px); animation:rise .45s ease .28s forwards}

/* CTA */
.cta{
  position:relative; isolation:isolate; display:inline-flex; align-items:center; gap:12px;
  padding:14px 28px; border-radius:16px; font:800 16px/1 var(--font); color:#fff; text-decoration:none;
  background:var(--accent); border:1px solid rgba(0,0,0,.06);
  box-shadow:0 16px 32px color-mix(in srgb,var(--accent) 28%, transparent);
  transition:transform .18s ease, box-shadow .18s ease, color .18s ease; overflow:hidden
}
.cta::after{content:""; position:absolute; inset:0; z-index:-1; background:var(--accent-dk); transform:scaleX(0); transform-origin:left center; transition:transform .35s ease; border-radius:inherit}
.cta:hover{transform:translateY(-1px); box-shadow:0 20px 40px color-mix(in srgb,var(--accent) 36%, transparent)}
.cta:hover::after{transform:scaleX(1)}

/* ================== FLOW ================== */
.container{display:none; min-height:100dvh; padding:calc(var(--header-h) + 16px) 16px 32px; position:relative; z-index:1;
  display:grid; place-items:center; align-content:center; justify-content:center;}
.shell{width:min(900px,100%)}
.panel{background:var(--paper); border:1px solid var(--line); border-radius:20px; box-shadow:0 16px 48px rgba(0,0,0,.08); overflow:hidden}

/* ================== Shared form styles ================== */
.section{padding:18px}
.grid{display:grid; gap:12px}
label{display:block;font:800 14px/1 var(--font);margin:16px 0 6px}
.req{ color:#DF1F26; margin-left:4px }
input[type="text"], input[type="email"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);font-size:15px;background:#fff}
input::placeholder{color:#9aa2ae}
input[type="text"]:focus, input[type="email"]:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(14,155,164,.15)}
.row{display:flex; gap:12px; flex-wrap:wrap}
.row .col{flex:1 1 240px}
.small-hint{color:#6b7280; font-size:12px}

.checks{margin-top:10px; display:grid; gap:10px}
.check{display:flex; gap:10px; align-items:flex-start}
.check input{accent-color:var(--accent); width:16px; height:16px; margin-top:2px}
.check div{font-size:13px; line-height:1.45; color:#111}
.check small{color:#DF1F26; display:block; margin-top:2px; font-size:11.5px}
.actions{display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:18px}
.hint{color:#6b7280; font-size:12px}
.foot{margin-top:14px; color:#6b7280; font-size:12px}
.err{ color:#b91c1c; font-size:12px; margin-top:8px; display:none }
.err.show{ display:block }

.survey-head{display:flex; align-items:center; gap:12px; position:sticky; top:0; background:var(--paper); padding:6px 2px 10px; z-index:2}
.stepchip{font:800 12px var(--font); color:#0b6f76; padding:6px 10px; border-radius:999px; background:#e9fbfd; border:1px solid #b9edf1}
.progress{flex:1; height:8px; background:#e6f6f7; border-radius:999px; overflow:hidden}
.bar{height:100%; width:0; background:linear-gradient(90deg,var(--accent),var(--accent-dk)); transition:width .25s var(--ease)}
.cardQ{ margin-top:8px; padding:18px; border:1px solid var(--line); border-radius:16px; background:#fff;
  box-shadow:0 6px 16px rgba(0,0,0,.05); animation:stepIn .24s var(--ease); }
@keyframes stepIn{ from{ opacity:0; transform:translateY(6px)} to{ opacity:1; transform:none}}
.qnum{font:800 12px var(--font); color:#0b6f76; letter-spacing:.08em; text-transform:uppercase; margin-bottom:6px}
.qtitle{margin:0 0 10px; font:800 clamp(18px,3.8vw,22px)/1.25 var(--font)}
.qhelp{color:#6b7280; font-size:13px; margin:-2px 0 10px}

.opt-grid{ --col-min:140px; display:grid; gap:10px; margin-top:6px;
  grid-template-columns: repeat(auto-fit, minmax(var(--col-min), 1fr));
  max-width:680px; margin-inline:auto; }
.opt{
  position:relative; isolation:isolate; display:flex; align-items:center; justify-content:center; text-align:center;
  border:1px solid var(--line); background:#fff; color:#111;
  padding:0 14px; border-radius:12px; font:800 14px var(--font); cursor:pointer;
  min-height:48px; overflow:hidden; word-break:break-word; white-space:normal; transition:.12s var(--ease);
}
.opt::after{content:""; position:absolute; inset:0; z-index:-1; background:var(--accent); transform:scaleX(0); transform-origin:left center; transition:transform .28s ease; border-radius:inherit}
.opt:hover{transform:translateY(-1px)}
.opt:hover::after{transform:scaleX(1)}
.opt:hover{color:#fff}
.opt.sel{color:#fff; border-color:var(--accent)}
.opt.sel::after{transform:scaleX(1)}

.slider-wrap{display:grid;gap:10px;justify-items:center;margin-top:12px}
.slider-value{font:800 18px/1 var(--font);color:var(--accent)}
.slider-scale{width:100%;display:flex;justify-content:space-between;font:700 11px/1 var(--font);color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
.slider-track{width:100%;max-width:640px;display:grid;gap:6px}
.slider-track input[type="range"]{width:100%;appearance:none;height:6px;border-radius:999px;background:#e6f6f7;outline:none}
.slider-track input[type="range"]::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 0 0 4px rgba(14,155,164,.25);cursor:pointer;transition:transform .18s var(--ease)}
.slider-track input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.06)}
.slider-track input[type="range"]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 0 0 4px rgba(14,155,164,.25);cursor:pointer;transition:transform .18s var(--ease)}
.slider-track input[type="range"]::-moz-range-thumb:hover{transform:scale(1.06)}
.slider-track input[type="range"]::-ms-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 0 0 4px rgba(14,155,164,.25);cursor:pointer}

.controls{display:flex; gap:10px; justify-content:center; align-items:center; padding-top:12px; border-top:1px dashed var(--line); margin-top:14px}
.btn{
  position:relative; isolation:isolate;
  display:inline-block; padding:12px 18px; border-radius:12px; font:800 14px/1 var(--font); color:#fff;
  background:var(--accent); border:1px solid rgba(0,0,0,.06); cursor:pointer;
  box-shadow:0 10px 18px color-mix(in srgb,var(--accent) 38%, transparent);
  overflow:hidden; transition:transform .18s ease, box-shadow .18s ease, color .18s ease;
}
.btn::after{content:""; position:absolute; inset:0; z-index:-1; background:var(--accent-dk); transform:scaleX(0); transform-origin:left center; transition:transform .35s ease; border-radius:inherit}
.btn:hover{transform:translateY(-1px)}
.btn:hover::after{transform:scaleX(1)}
.btn.alt{background:#e9fbfd; color:#0b6f76; box-shadow:none}
.btn[disabled]{opacity:.55; cursor:not-allowed; filter:grayscale(.35)}
.state{color:#b45309; font-size:12px; text-align:center; min-height:1em; margin-top:4px}

/* Reward ticket */
.section.reward-section{padding:18px}
.coupon-wrap{ display:grid; gap:16px; justify-items:center; text-align:center; margin:8px 0 6px; padding-inline:12px }
.ticket{
  position:relative; width:100%; max-width:680px; margin:0 auto; background:#fff; border-radius:20px; 
  box-shadow:0 18px 60px rgba(0,0,0,.16); padding:22px; overflow:hidden;
  outline:2px dashed var(--coupon-red); outline-offset:-8px;
  --cut:22px;
  background:
    radial-gradient(circle var(--cut) at left 50%, transparent 99%, #fff 100%) left center/var(--cut) 100% no-repeat,
    radial-gradient(circle var(--cut) at right 50%, transparent 99%, #fff 100%) right center/var(--cut) 100% no-repeat;
}
.ticket-head{ display:flex; gap:10px; align-items:center; justify-content:center; }
.ticket-head img{ height:40px }
.ticket-sub{ color:#6b7280; font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing:.14em; }
.ticket-title{ font:800 clamp(18px,4.2vw,26px)/1.1 var(--font); margin:10px 0 2px; }
.ticket-code{
  font:800 clamp(22px,5vw,30px)/1 var(--font); letter-spacing:2px; color:var(--coupon-ink);
  background:#fff5f6; border:2px dashed var(--coupon-red); padding:12px 16px; border-radius:14px; display:inline-block; margin-top:10px;
}
.ticket-foot{ color:#6b7280; font-size:12px; margin-top:8px }
.coupon-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:4px }
.ticket-ill{ position:absolute; right:-6px; top:16px; width:160px; opacity:.18; transform:rotate(-6deg); pointer-events:none }

/* Loading overlay */
.overlay{
  position:fixed; inset:0; display:grid; place-items:center;
  background:rgba(255,255,255,.65); backdrop-filter:blur(8px) saturate(120%);
  opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:50;
}
.overlay.show{ opacity:1; pointer-events:auto; }
.loader{ display:grid; place-items:center; gap:10px; text-align:center; color:#334155; font-weight:700; font-size:14px }
.loader img{ height:64px; width:auto; filter:drop-shadow(0 10px 18px rgba(0,0,0,.16)); animation:pulse 1.2s ease-in-out infinite }
@keyframes pulse{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.06) } }

/* Typeahead dropdown */
.typeahead{
  position:relative;
}
.ta-list{
  position:absolute; left:0; right:0; top:calc(100% + 4px);
  background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.08);
  max-height:220px; overflow:auto; z-index:10; display:none;
}
.ta-item{
  padding:10px 12px; cursor:pointer; font-size:14px;
}
.ta-item:hover, .ta-item.active{ background:#e9fbfd; color:#0b6f76; }
</style>
</head>
<body class="lock">

<!-- Background -->
<div class="bg" aria-hidden="true">
  <div class="scroller">
    <div class="belt">
      <img class="fuji f1" src="./assets/img/mtfuji.png" alt=""><img class="fuji f2" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f3" src="./assets/img/mtfuji.png" alt=""><img class="fuji f4" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f5" src="./assets/img/mtfuji.png" alt=""><img class="fuji f6" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f7" src="./assets/img/mtfuji.png" alt=""><img class="fuji f8" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f9" src="./assets/img/mtfuji.png" alt=""><img class="fuji f10" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f11" src="./assets/img/mtfuji.png" alt=""><img class="fuji f12" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f13" src="./assets/img/mtfuji.png" alt=""><img class="fuji f14" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f15" src="./assets/img/mtfuji.png" alt=""><img class="fuji f16" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f17" src="./assets/img/mtfuji.png" alt=""><img class="fuji f18" src="./assets/img/mtfuji.png" alt="">
    </div>
    <div class="belt">
      <img class="fuji f1" src="./assets/img/mtfuji.png" alt=""><img class="fuji f2" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f3" src="./assets/img/mtfuji.png" alt=""><img class="fuji f4" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f5" src="./assets/img/mtfuji.png" alt=""><img class="fuji f6" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f7" src="./assets/img/mtfuji.png" alt=""><img class="fuji f8" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f9" src="./assets/img/mtfuji.png" alt=""><img class="fuji f10" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f11" src="./assets/img/mtfuji.png" alt=""><img class="fuji f12" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f13" src="./assets/img/mtfuji.png" alt=""><img class="fuji f14" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f15" src="./assets/img/mtfuji.png" alt=""><img class="fuji f16" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f17" src="./assets/img/mtfuji.png" alt=""><img class="fuji f18" src="./assets/img/mtfuji.png" alt="">
    </div>
  </div>
</div>

<!-- subtle food plates fixed in corners -->
<div class="food-bg" aria-hidden="true">
  <img class="left-bowl" src="./assets/img/mendo-ramen.png" alt="">
  <img class="right-gyoza" src="./assets/img/gyoza.png" alt="">
</div>

<!-- Header -->
<header id="hdr" class="site-header" aria-hidden="true">
  <nav class="nav">
    <img class="brand-img" src="./assets/img/nhlogo.png" alt="Nippon Hasha">
    <div class="brand-right">
      <div class="brand-name">Mendokoro • Yushoken</div>
      <div class="brand-sub">Food Truck Survey</div>
    </div>
  </nav>
</header>

<!-- HERO -->
<section class="hero" id="hero">
  <div class="wrap">
    <div class="hero-logo"><img src="./assets/img/mendokorologo.png" alt="Mendokoro Ramenba"></div>
    <div class="hero-logo"><img src="./assets/img/yushokenlogo.png" alt="Ramen Yushoken"></div>
    <div class="subtitle">A Nippon Hasha Brand</div>
    <div class="accent-underline" aria-hidden="true"></div>
    <div class="strap">Food Truck Survey</div>
    <p class="lead">Help us improve and get a small treat from us on your next visit!</p>
    <a href="#start" id="startBtn" class="cta">Start Survey →</a>
  </div>
</section>

<!-- FLOW -->
<div class="container" id="start" style="display:none">
  <main class="shell panel">
    <!-- Gate -->
    <section id="stepGate" class="section" role="form">
      <h1 style="font:800 clamp(20px,3.6vw,26px)/1.18 var(--font); margin:2px 0">Start your survey</h1>
      <p class="hint" style="margin-bottom:10px">Enter your details to proceed.</p>

      <form id="gateForm" novalidate>
        <label for="receipt">Receipt Number<span class="req" aria-hidden="true">*</span></label>
        <input id="receipt" name="receipt" type="text" inputmode="text" maxlength="18"
               placeholder="e.g., MDKB-123456-789101" required aria-describedby="receiptHelp receiptErr">
        <div id="receiptHelp" class="hint">Format: <code>AAAA-000000-000000</code>. Brand prefixes allowed: MD (Mendokoro), YS (Yushoken).</div>
        <div id="receiptErr" class="err">Invalid receipt format or brand code.</div>

        <div class="row">
          <div class="col">
            <label for="email">Email<span class="req" aria-hidden="true">*</span></label>
            <input id="email" name="email" type="email" placeholder="you@example.com" required>
          </div>
          <div class="col">
            <label for="name">Name <span class="hint">(optional)</span></label>
            <input id="name" name="name" type="text" placeholder="Juan Dela Cruz">
          </div>
        </div>

        <div class="checks" aria-label="Consent options">
          <label class="check">
            <input id="dpa" name="dpa" type="checkbox" required>
            <div>I agree to the Philippine Data Privacy Act and consent to the processing of my responses for service improvement.<small>Required to proceed.</small></div>
          </label>
          <label class="check">
            <input id="promo" name="promo" type="checkbox">
            <div>I’d like to receive emails about promotions and updates.<small>Optional.</small></div>
          </label>
        </div>

        <div class="actions">
          <button id="continueBtn" class="cta" type="submit" disabled>Continue →</button>
          <span id="stateMsg" class="hint" aria-live="polite">Fill the required fields to continue.</span>
        </div>

        <p class="foot">By continuing, you acknowledge Nippon Hasha’s policies and terms of service.</p>
      </form>
    </section>

    <!-- Survey -->
    <section id="stepSurvey" class="section" style="display:none">
      <div class="survey-head">
        <div id="stepChip" class="stepchip">Question 1 of 12</div>
        <div class="progress"><div id="bar" class="bar"></div></div>
      </div>

      <div id="qwrap"></div>

      <div class="controls">
        <button id="backBtn" class="btn alt" type="button">← Back</button>
        <button id="nextBtn" class="btn" type="button" disabled>Next →</button>
        <button id="submitBtn" class="btn" type="button" style="display:none" disabled>Submit →</button>
      </div>
      <div id="stateQ" class="state" aria-live="polite"></div>
    </section>

    <!-- Reward -->
    <section id="stepReward" class="section reward-section" style="display:none">
      <div class="coupon-wrap">
        <div class="ticket" id="ticket">
          <img class="ticket-ill" src="./assets/img/gyoza.png" alt="">
          <div class="ticket-head">
            <img src="./assets/img/mendokorologo.png" alt="Mendokoro">
            <img src="./assets/img/yushokenlogo.png" alt="Yushoken">
          </div>
          <div class="ticket-sub">A Nippon Hasha Brand</div>
          <div class="ticket-title">Thank you for your time! Use this code to claim your FREE 3-PIECE GYOZA on us!</div>
          <div id="rewardCode" class="ticket-code">—</div>
          <div class="ticket-foot">Show this at the truck to redeem • One-time use</div>
        </div>
        <div class="coupon-actions">
          <button id="copyBtn" class="btn" type="button">Copy Code</button>
          <button id="saveImgBtn" class="btn" type="button">Save Coupon</button>
        </div>
      </div>
      <canvas id="couponCanvas" width="1200" height="640" style="display:none"></canvas>
    </section>
  </main>
</div>


<!-- Loading overlay -->
<div class="overlay" id="overlay">
  <div class="loader">
    <img src="./assets/img/mendokorologo.png" alt="Loading">
    Storing your details…
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

<!-- QUESTIONS (updated per feedback) -->
<script id="QUESTIONS_JSON" type="application/json">[
  {"id":"q1","type":"buttons","prompt":"Did you enjoy your Blue Truck Pop-up experience?","options":["Yes","No"]},

  {"id":"q2","type":"buttons","prompt":"Where did you hear about our Blue Truck Pop-up?","options":["Official Website","Official Social Media Pages","Content Creator / Influencer","Friend or Family","Passing By","Mall or Event Poster","Others"],"otherText":true,"otherId":"q2_other","otherPlaceholder":"Please specify"},

  {"id":"q3","type":"buttons","prompt":"Have you been to one of our branches before?","options":["Yes","No"]},
  {"id":"q3a","type":"buttons","prompt":"If yes, which branch?","options":["Cebu","Ortigas","Pasay","Rockwell","Alabang","Panay","Katipunan","None / Not applicable"],"showIf":{"id":"q3","equals":"Yes"}},

  {"id":"q4","type":"buttons","prompt":"Where do you want to see our Blue Truck next?","options":["City","Mall"],"followups":[
      {"when":"City","id":"q4_city","type":"text","placeholder":"Type a city in the Philippines","suggestKey":"cities","required":true},
      {"when":"Mall","id":"q4_mall","type":"text","placeholder":"Optional: which mall?","suggestKey":"malls","required":false}
  ]},

  {"id":"q5","type":"buttons","prompt":"Are you working near or living near here?","options":["Working","Living"],"followups":[
      {"when":"Working","id":"q5_place","type":"text","placeholder":"Which office / company?","suggestKey":"places","required":true},
      {"when":"Living","id":"q5_place","type":"text","placeholder":"Which village / subdivision?","suggestKey":"places","required":true}
  ]},

  {"id":"q6","type":"buttons","prompt":"Does the food and service achieve value for money?","options":["Yes","No"]},

  {"id":"q7_food","type":"slider","prompt":"How would you rate our food quality today?","min":1,"max":10,"step":1,"labels":{"min":"Very Dissatisfied","max":"Very Satisfied"}},
  {"id":"q7_service","type":"slider","prompt":"How would you rate our service today?","min":1,"max":10,"step":1,"labels":{"min":"Very Dissatisfied","max":"Very Satisfied"}},
  {"id":"q7_price","type":"slider","prompt":"How would you rate the value for price today?","min":1,"max":10,"step":1,"labels":{"min":"Very Dissatisfied","max":"Very Satisfied"}},

  {"id":"q8","type":"slider","prompt":"On a scale of 1 to 10, how likely are you to recommend our brand to friends and family?","min":1,"max":10,"step":1,"labels":{"min":"Not Likely","max":"Extremely Likely"}},

  {"id":"q10_return","type":"slider","prompt":"Based on today's visit, how likely are you to dine with us again soon?","min":1,"max":10,"step":1,"labels":{"min":"Not Likely","max":"Very Likely"}},

  {"id":"q9","type":"buttons","prompt":"Which cuisines are you most interested in?","options":["Filipino","Chinese","Italian","Mexican","South American","Japanese"],"multi":true,"otherText":true,"otherId":"q9_other","otherPlaceholder":"Other cuisine (please specify)"},

  {"id":"q10","type":"buttons","prompt":"Would you love to hear more about us and where we are headed?","options":["Yes","No"]}
]</script>

<script>
/* ---------- Supabase ---------- */
const SUPABASE_URL = 'https://xkzicpfxlvgovugumspr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhremljcGZ4bHZnb3Z1Z3Vtc3ByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyODI1MzAsImV4cCI6MjA3Mjg1ODUzMH0.8xykX92QwVWccQyOz60ONb_CirdbGcKvQD8FjO8RJrA';
const sb = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- Landing → Flow ---------- */
const hero=document.getElementById('hero'), container=document.querySelector('.container'), hdr=document.getElementById('hdr');
document.getElementById('startBtn').addEventListener('click',e=>{
  e.preventDefault();
  hero.style.transition='opacity .22s var(--ease), transform .22s var(--ease)';
  hero.style.opacity='0'; hero.style.transform='translateY(-6px)';
  setTimeout(()=>{
    hero.style.display='none';
    container.style.display='grid';
    hdr.classList.add('show'); hdr.removeAttribute('aria-hidden');
    document.body.classList.remove('lock');
  }, 180);
});

/* ---------- Gate logic ---------- */
const gateForm=document.getElementById('gateForm');
const receiptEl=document.getElementById('receipt'), emailEl=document.getElementById('email'), nameEl=document.getElementById('name');
const dpaEl=document.getElementById('dpa'), promoEl=document.getElementById('promo');
const continueBtn=document.getElementById('continueBtn'), stateMsg=document.getElementById('stateMsg'), receiptErr=document.getElementById('receiptErr');
const overlay=document.getElementById('overlay');

(function(){
  const pattern = /^[A-Z]{4}-\d{6}-\d{6}$/;
  const allowedTwo = /^(MD|YS|MR|KZ)/;
  function formatReceipt(raw){
    const clean = raw.replace(/[^a-zA-Z0-9]/g,'').toUpperCase();
    const brand = clean.replace(/[^A-Z]/g,'').slice(0,4);
    const nums  = clean.replace(/[^0-9]/g,'').slice(0,12);
    const part1 = brand, part2 = nums.slice(0,6), part3 = nums.slice(6,12);
    let out = part1;
    if(part1.length===4 && part2.length>0) out += '-' + part2;
    if(part1.length===4 && part2.length===6 && part3.length>0) out += '-' + part3;
    return out;
  }
  function validateReceipt(){
    const v = receiptEl.value.trim();
    const okPattern = pattern.test(v);
    const okBrand = allowedTwo.test(v.slice(0,2));
    const ok = okPattern && okBrand;
    receiptEl.setCustomValidity(ok ? '' : 'Format must be AAAA-000000-000000 with MD/YS/MR/KZ prefix.');
    receiptErr.classList.toggle('show', !ok && v.length>0);
    return ok;
  }
  receiptEl.addEventListener('input', ()=>{
    const before=receiptEl.value, caret=receiptEl.selectionStart;
    receiptEl.value = formatReceipt(receiptEl.value);
    if(receiptEl.value.length>before.length && receiptEl.value[caret]==='-'){
      receiptEl.setSelectionRange(caret+1, caret+1);
    }
    validateReceipt(); updateGate();
  });
  receiptEl.addEventListener('blur', validateReceipt);

  emailEl.addEventListener('input', ()=>{ emailEl.setCustomValidity(''); updateGate(); });
  emailEl.addEventListener('invalid', ()=>{
    if(emailEl.validity.typeMismatch || emailEl.validity.valueMissing){
      emailEl.setCustomValidity('Please enter a valid email (e.g., you@example.com).');
    }
  });

  dpaEl.addEventListener('change', updateGate);

  function updateGate(){
    const okRec = validateReceipt();
    const okEmail = emailEl.validity.valid;
    const okDpa = dpaEl.checked;
    const ok = okRec && okEmail && okDpa;
    continueBtn.disabled = !ok;
    stateMsg.textContent = ok ? 'All set! You can now start your survey.' : 'Fill the required fields to continue.';
  }
  document.addEventListener('DOMContentLoaded', updateGate);
})();

/* ---------- Typeahead (no big dropdown, suggests as you type) ---------- */
const PH_CITIES = [
  // NCR (16 + 1)
  "Caloocan","Las Piñas","Makati","Malabon","Mandaluyong","Manila","Marikina",
  "Muntinlupa","Navotas","Parañaque","Pasay","Pasig","Quezon City","San Juan",
  "Taguig","Valenzuela","Pateros",

  // Luzon (excluding NCR)
  "Alaminos","Angeles","Antipolo","Bacoor","Balanga","Batac","Batangas City","Baguio",
  "Cabanatuan","Cabuyao","Candon","Cauayan","Cavite City","Dagupan","Dasmariñas",
  "Gapan","General Trias","Iriga","Laoag","Legazpi","Ligao","Lipa","Lucena",
  "Malolos","Meycauayan","Naga","Olongapo","Palayan","Puerto Princesa",
  "San Carlos (Pangasinan)","San Fernando (La Union)","San Fernando (Pampanga)",
  "San Jose (Nueva Ecija)","San Jose del Monte","San Pablo","Santa Rosa",
  "Santiago","Sorsogon City","Tabuk","Tacurong","Tarlac City","Tayabas","Trece Martires",
  "Vigan",

  // Visayas
  "Bacolod","Bago","Bais","Bayawan","Baybay","Borongan","Calbayog","Catbalogan",
  "Cebu City","Danao","Dumaguete","Guihulngan","Iloilo City","Kananga (Ormoc merged?)","Kananga no","Kabankalan",
  "Lapu-Lapu","Maasin","Mandaue","Ormoc","Passi","Roxas City","Silay","Sipalay",
  "Tagbilaran","Tacloban","Talisay (Cebu)","Talisay (Negros Occidental)","Toledo",
  "Victorias",

  // Mindanao
  "Butuan","Cabadbaran","Cagayan de Oro","Cotabato City","Davao City","Digos",
  "Dipolog","Dapitan","El Salvador","Gingoog","General Santos","Iligan","Isabela City",
  "Kidapawan","Koronadal","Mati","Malaybalay","Marawi","Oroquieta","Ozamiz","Pagadian",
  "Panabo","Samal","San Carlos (Negros Occidental)","Surigao City","Tagum",
  "Tangub","Tandag","Valencia","Zamboanga City"
];

function attachTypeahead(input, list, onPick){
  const wrap = document.createElement('div');
  wrap.className = 'typeahead';
  input.parentNode.insertBefore(wrap, input);
  wrap.appendChild(input);
  const ul = document.createElement('div'); ul.className='ta-list'; wrap.appendChild(ul);
  let active = -1;

  function render(q){
    const qv = q.trim().toLowerCase();
    const seen = new Set();
    const fromHistory = (suggestHistory.cities||[]).filter(x=>x && x.toLowerCase().startsWith(qv));
    const base = list.filter(x=>x.toLowerCase().startsWith(qv));
    const items = [...fromHistory, ...base].filter(x=>{ if(seen.has(x)) return false; seen.add(x); return true; }).slice(0,20);
    ul.innerHTML='';
    active = -1;
    if(!qv || items.length===0){ ul.style.display='none'; return; }
    items.forEach((txt,i)=>{
      const it=document.createElement('div'); it.className='ta-item'; it.textContent=txt;
      it.addEventListener('mousedown', e=>{ e.preventDefault(); pick(txt); });
      ul.appendChild(it);
    });
    ul.style.display='block';
  }
  function highlight(){
    [...ul.children].forEach((c,i)=> c.classList.toggle('active', i===active));
  }
  function pick(val){
    input.value = val;
    ul.style.display='none';
    onPick?.(val);
  }

  input.addEventListener('input', ()=> render(input.value));
  input.addEventListener('focus', ()=> render(input.value));
  input.addEventListener('blur', ()=> setTimeout(()=>ul.style.display='none', 100));
  input.addEventListener('keydown', e=>{
    const n = ul.children.length;
    if(!n) return;
    if(e.key==='ArrowDown'){ active = (active+1)%n; highlight(); e.preventDefault(); }
    else if(e.key==='ArrowUp'){ active = (active-1+n)%n; highlight(); e.preventDefault(); }
    else if(e.key==='Enter' && active>-1){ e.preventDefault(); pick(ul.children[active].textContent); }
  });
}

/* ---------- Survey model/rendering ---------- */
const QUESTIONS = JSON.parse(document.getElementById('QUESTIONS_JSON').textContent||'[]');
const stepSurvey=document.getElementById('stepSurvey'), stepGate=document.getElementById('stepGate'), stepReward=document.getElementById('stepReward');
const qwrap=document.getElementById('qwrap'), bar=document.getElementById('bar'), chip=document.getElementById('stepChip');
const nextBtn=document.getElementById('nextBtn'), backBtn=document.getElementById('backBtn'), submitBtn=document.getElementById('submitBtn'), stateQ=document.getElementById('stateQ');
const surveyState={idx:0,answers:{}};

function choiceValue(val){
  if(val && typeof val==='object'){
    if('value' in val) return val.value;
    if(Array.isArray(val.choices)) return val.choices;
    if('choice' in val) return val.choice;
    return '';
  }
  return val ?? '';
}
function isQuestionVisible(q){
  if(!q) return false;
  const cond=q.showIf;
  if(!cond) return true;
  const current=choiceValue(surveyState.answers[cond.id]);
  if(cond.equals!==undefined){
    const expected=Array.isArray(cond.equals)?cond.equals:[cond.equals];
    if(Array.isArray(current)) return current.some(val=>expected.includes(val));
    return expected.includes(current);
  }
  if(cond.notEquals!==undefined){
    const blocked=Array.isArray(cond.notEquals)?cond.notEquals:[cond.notEquals];
    if(Array.isArray(current)) return !current.some(val=>blocked.includes(val));
    return !blocked.includes(current);
  }
  if(cond.truthy){
    if(Array.isArray(current)) return current.length>0;
    return !!current;
  }
  if(cond.falsy){
    if(Array.isArray(current)) return current.length===0;
    return !current;
  }
  return true;
}
function pruneHiddenAnswers(sourceId){
  QUESTIONS.forEach(q=>{
    if(q.showIf && q.showIf.id===sourceId && !isQuestionVisible(q)){
      delete surveyState.answers[q.id];
      if(q.otherId) delete surveyState.answers[q.otherId];
      if(Array.isArray(q.followups)){
        q.followups.forEach(f=> delete surveyState.answers[f.id]);
      }
    }
  });
}
function findNextVisibleIndex(startIdx,direction){
  let idx=startIdx+direction;
  while(idx>=0 && idx<QUESTIONS.length){
    if(isQuestionVisible(QUESTIONS[idx])) return idx;
    idx+=direction;
  }
  return idx;
}
function nearestVisibleIndex(idx){
  if(isQuestionVisible(QUESTIONS[idx])) return idx;
  const forward=findNextVisibleIndex(idx,1);
  if(forward>=0 && forward<QUESTIONS.length) return forward;
  const backward=findNextVisibleIndex(idx,-1);
  if(backward>=0 && backward<QUESTIONS.length) return backward;
  return 0;
}
function visibleQuestions(){
  return QUESTIONS.filter(isQuestionVisible);
}

/* local suggestion history */
const storeKey='mdk_suggest_history';
const suggestHistory=JSON.parse(localStorage.getItem(storeKey)||'{}');
function pushHistory(key,val){
  if(!key||!val) return;
  const arr = Array.isArray(suggestHistory[key]) ? suggestHistory[key] : [];
  if(!arr.includes(val)) arr.unshift(val);
  suggestHistory[key]=arr.slice(0,40);
  localStorage.setItem(storeKey, JSON.stringify(suggestHistory));
}

/* normalize for DB */
function normalizeAnswers(raw) {
  const out = {};
  out.q1 = (raw.q1?.choice || raw.q1 || "").toString();
  out.q2_choice = (raw.q2?.choice || "").toString();
  out.q2_other  = (raw.q2_other || "").trim();
  out.q3 = (raw.q3?.choice || raw.q3 || "").toString();
  out.q3_branch = (raw.q3a?.choice || raw.q3a || "").toString();
  out.q4 = (raw.q4?.choice || raw.q4 || "").toString();
  out.q4_city = (raw.q4_city || "").trim();
  out.q4_mall = (raw.q4_mall || "").trim();
  out.q5 = (raw.q5?.choice || raw.q5 || "").toString();
  out.q5_place = (raw.q5_place || "").trim();
  out.q6 = (raw.q6?.choice || raw.q6 || "").toString();

  const sliderVal = (val)=>{
    if(val && typeof val==='object' && val.value!==undefined) return val.value;
    return val;
  };
  const foodVal = sliderVal(raw.q7_food);
  const serviceVal = sliderVal(raw.q7_service);
  const priceVal = sliderVal(raw.q7_price);
  const npsVal = sliderVal(raw.q8);
  const returnVal = sliderVal(raw.q10_return);

  out.q7_food = Number.isFinite(foodVal) ? foodVal : null;
  out.q7_service = Number.isFinite(serviceVal) ? serviceVal : null;
  out.q7_price = Number.isFinite(priceVal) ? priceVal : null;
  out.q8_nps = Number.isFinite(npsVal) ? npsVal : null;
  out.q10_return = Number.isFinite(returnVal) ? returnVal : null;

  const q9Obj = raw.q9 && typeof raw.q9==='object' ? raw.q9 : {};
  const q9Choices = Array.isArray(q9Obj.choices) ? q9Obj.choices.filter(Boolean) : [];
  const q9Single = q9Obj.choice || (typeof raw.q9==='string' ? raw.q9 : '');
  out.q9_choices = q9Choices;
  const combined = q9Choices.length ? q9Choices.join(', ') : (q9Single ? q9Single.toString() : '');
  out.q9 = combined;
  out.q9_other = (raw.q9_other || "").trim();
  out.q10 = (raw.q10?.choice || raw.q10 || "").toString();
  return out;
}

function setProgress(){
  const visible=visibleQuestions();
  const current=QUESTIONS[surveyState.idx];
  const pos=Math.max(visible.findIndex(q=>q.id===current?.id),0);
  const total=Math.max(visible.length,1);
  chip.textContent=`Question ${Math.min(pos+1,total)} of ${total}`;
  bar.style.width=((pos+1)/total)*100+'%';
}
function validStep(){
  const q=QUESTIONS[surveyState.idx]; 
  if(!q) return false;
  const v=surveyState.answers[q.id];
  if(q.type==='text') return !!(v && String(v).trim()!=='');
  if(q.type==='buttons'){
    const selections = q.multi
      ? (Array.isArray(v?.choices) ? v.choices.filter(Boolean) : [])
      : (v && v.choice ? [v.choice] : []);
    if(selections.length===0) return false;

    if(q.otherText){
      const needsOther = q.multi ? selections.includes('Others') : selections[0]==='Others';
      if(needsOther){
        const otherRaw = surveyState.answers[q.otherId];
        const otherText = typeof otherRaw==='string' ? otherRaw.trim() : '';
        if(!otherText) return false;
      }
    }

    if(Array.isArray(q.followups)){
      const checkFollowup = (follow)=>{
        if(!follow.required) return true;
        const followVal = surveyState.answers[follow.id];
        const followText = typeof followVal==='string' ? followVal.trim() : '';
        return !!followText;
      };
      if(q.multi){
        const active = q.followups.filter(f=>selections.includes(f.when));
        if(active.length){
          return active.every(checkFollowup);
        }
      }else{
        const match = q.followups.find(f=>f.when===selections[0]);
        if(match) return checkFollowup(match);
      }
    }
    return true;
  }
  if(q.type==='slider'){
    const val = (typeof v==='object' && v) ? v.value : v;
    return val !== undefined && val !== null && val!=='';
  }
  return !!v;
}
function updateStepButtons(){
  const isValid = validStep();
  const nextIdx = findNextVisibleIndex(surveyState.idx, 1);
  const prevIdx = findNextVisibleIndex(surveyState.idx, -1);
  const last = nextIdx >= QUESTIONS.length;
  nextBtn.style.display = last ? 'none' : 'inline-block';
  submitBtn.style.display = last ? 'inline-block' : 'none';
  nextBtn.disabled = !isValid;
  submitBtn.disabled = !isValid;
  backBtn.style.display = prevIdx < 0 ? 'none' : 'inline-block';
  stateQ.textContent = isValid ? '' : 'Answer to continue.';
  setProgress();
}

function renderButtons(q){
  const wrap=document.createElement('div');
  const grid=document.createElement('div'); grid.className='opt-grid';
  wrap.appendChild(grid);

  const getSelected=()=>{
    const current=surveyState.answers[q.id];
    if(q.multi){
      return Array.isArray(current?.choices) ? current.choices : [];
    }
    return current?.choice || '';
  };
  const setSelected=(val)=>{
    if(q.multi){
      surveyState.answers[q.id]={choices:val};
    }else{
      surveyState.answers[q.id]={choice:val};
    }
  };
  const syncButtons=()=>{
    const selected=getSelected();
    [...grid.children].forEach(btn=>{
      const txt=btn.textContent;
      const isSel=q.multi ? selected.includes(txt) : selected===txt;
      btn.classList.toggle('sel', isSel);
    });
  };

  (q.options||[]).forEach(opt=>{
    const b=document.createElement('button'); b.type='button'; b.className='opt'; b.textContent=opt;
    b.onclick=()=>{
      if(q.multi){
        const selections=[...getSelected()];
        const idx=selections.indexOf(opt);
        if(idx>-1) selections.splice(idx,1);
        else selections.push(opt);
        setSelected(selections);
      }else{
        setSelected(opt);
      }
      pruneHiddenAnswers(q.id);
      syncButtons();
      refreshFollowups(q, wrap);
      updateStepButtons();
    };
    grid.appendChild(b);
  });
  syncButtons();

  // "Others" textbox
  if(q.otherText){
    const holder=document.createElement('div'); holder.style.marginTop='10px';
    const input=document.createElement('input');
    input.type='text'; input.placeholder=q.otherPlaceholder||'Please specify'; input.id=q.otherId;
    input.value = surveyState.answers[q.otherId] || '';
    input.addEventListener('input',()=>{ surveyState.answers[q.otherId]=input.value; updateStepButtons(); });
    holder.appendChild(input);
    const hint=document.createElement('div'); hint.className='small-hint'; hint.textContent='Shown only if “Others” is chosen.'; holder.appendChild(hint);
    wrap.appendChild(holder);
    function toggleOthers(){
      const selected=getSelected();
      const isOthers=q.multi ? selected.includes('Others') : selected==='Others';
      holder.style.display = isOthers ? 'block' : 'none';
    }
    toggleOthers(); wrap.toggleOthers=toggleOthers;
  }

  // followups area
  if(Array.isArray(q.followups) && q.followups.length){
    const fbox=document.createElement('div'); fbox.style.marginTop='10px'; fbox.className='grid';
    wrap.appendChild(fbox);
    wrap.fbox=fbox;
  }

  function refreshFollowups(q, wrap){
    if(!wrap.fbox){ wrap.toggleOthers?.(); return; }
    wrap.fbox.innerHTML='';
    if(q.multi){ wrap.toggleOthers?.(); return; }
    const picked = surveyState.answers[q.id]?.choice;
    const f = q.followups.find(x=>x.when===picked);
    if(!f){ wrap.toggleOthers?.(); return; }

    const label=document.createElement('label'); label.textContent=f.placeholder || 'Please specify';
    const fieldWrap=document.createElement('div'); fieldWrap.className='typeahead';
    const input=document.createElement('input'); input.type='text'; input.placeholder=f.placeholder||'Please specify';
    input.value = surveyState.answers[f.id]||'';
    input.addEventListener('input', ()=>{ surveyState.answers[f.id]=input.value; updateStepButtons(); });
    fieldWrap.appendChild(input); wrap.fbox.appendChild(label); wrap.fbox.appendChild(fieldWrap);

    // Attach typeahead to CITY only (others rely on history)
    if(f.id==='q4_city'){
      attachTypeahead(input, PH_CITIES, (v)=>{ surveyState.answers[f.id]=v; updateStepButtons(); });
    }
    wrap.toggleOthers?.();
  }
  wrap.refreshFollowups=()=>refreshFollowups(q,wrap);

  // initial render
  wrap.refreshFollowups?.();
  return wrap;
}

function renderSlider(q){
  const wrap=document.createElement('div'); wrap.className='slider-wrap';
  const min=parseFloat(q.min ?? 0) || 0;
  const max=parseFloat(q.max ?? 10) || 10;
  const step=parseFloat(q.step ?? 1) || 1;
  const stored = surveyState.answers[q.id];
  const storedVal = typeof stored==='object' && stored && typeof stored.value==='number' ? stored.value : null;
  const defaultVal = storedVal!==null ? storedVal : Math.round((min+max)/2);

  const describe=(val)=>`Score: ${val}/${max}`;
  const valueLabel=document.createElement('div'); valueLabel.className='slider-value';
  valueLabel.textContent = storedVal!==null ? describe(storedVal) : `Drag to choose (1-${max})`;
  wrap.appendChild(valueLabel);

  const track=document.createElement('div'); track.className='slider-track';
  const input=document.createElement('input');
  input.type='range';
  input.min=String(min);
  input.max=String(max);
  input.step=String(step);
  input.value=String(defaultVal);
  input.setAttribute('aria-label', q.prompt || 'slider question');
  track.appendChild(input);
  wrap.appendChild(track);

  const scale=document.createElement('div'); scale.className='slider-scale';
  const minSpan=document.createElement('span'); minSpan.textContent=q.labels?.min || String(min);
  const maxSpan=document.createElement('span'); maxSpan.textContent=q.labels?.max || String(max);
  scale.appendChild(minSpan); scale.appendChild(maxSpan);
  wrap.appendChild(scale);

  if(storedVal!==null){
    surveyState.answers[q.id]={value:storedVal};
  }

  const update=(val)=>{
    surveyState.answers[q.id]={value:val};
    valueLabel.textContent=describe(val);
    updateStepButtons();
  };

  input.addEventListener('input', ()=>{
    update(Number(input.value));
  });
  input.addEventListener('change', ()=>{
    update(Number(input.value));
  });

  return wrap;
}

function renderText(q){
  const box=document.createElement('div'); 
  const input=document.createElement('input'); input.type='text'; input.placeholder=q.placeholder||'Type here';
  input.value = surveyState.answers[q.id]||'';
  input.addEventListener('input', ()=>{ surveyState.answers[q.id]=input.value; updateStepButtons(); });
  box.appendChild(input);
  return box;
}

function renderQ(){
  surveyState.idx = nearestVisibleIndex(surveyState.idx);
  const q=QUESTIONS[surveyState.idx];
  if(!q || !isQuestionVisible(q)) return;
  const visible=visibleQuestions();
  const position=Math.max(visible.findIndex(item=>item.id===q.id),0);
  qwrap.innerHTML='';
  const card=document.createElement('div'); card.className='cardQ';
  const num=document.createElement('div'); num.className='qnum'; num.textContent=`Question ${position+1}`;
  const title=document.createElement('h3'); title.className='qtitle'; title.textContent=q.prompt;
  card.appendChild(num); card.appendChild(title);

  if(q.type==='buttons'){ card.appendChild(renderButtons(q)); }
  else if(q.type==='text'){ card.appendChild(renderText(q)); }
  else if(q.type==='slider'){ card.appendChild(renderSlider(q)); }
  qwrap.appendChild(card);
  updateStepButtons();
}
function goNextOrSubmit(){
  const nextIdx = findNextVisibleIndex(surveyState.idx, 1);
  if(nextIdx >=0 && nextIdx < QUESTIONS.length){
    surveyState.idx = nextIdx;
    renderQ();
  }else if(validStep()){
    submitBtn.click();
  }
}

/* ---------- Gate submit ---------- */
gateForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(continueBtn.disabled) return;
  overlay.classList.add('show');

  let gateRowId = null;
  try{
    if(sb){
      const { data, error } = await sb.from('submissions').insert([{
        brand:'Mendokoro/Yushoken', flow:'with_receipt', has_receipt:true,
        receipt_no:receiptEl.value.trim(), email:emailEl.value.trim(), name:nameEl.value.trim()||null,
        consent:dpaEl.checked, subscribed:promoEl.checked
      }]).select().single();
      if(error) throw error;
      gateRowId = data?.id || null;
    }
  }catch(err){ console.warn('Gate save skipped/failed:', err?.message); }

  setTimeout(()=>{
    overlay.classList.remove('show');
    stepGate.style.display='none';
    stepSurvey.style.display='block';
    surveyState.idx=0; surveyState.answers={};
    renderQ(); setProgress();
    stepSurvey.dataset.gateId = gateRowId || '';
  }, 600);
});

/* Navigation */
backBtn.onclick=()=>{
  const prevIdx = findNextVisibleIndex(surveyState.idx, -1);
  if(prevIdx>=0){
    surveyState.idx = prevIdx;
    renderQ();
  }else{
    stepSurvey.style.display='none';
    stepGate.style.display='block';
  }
};
nextBtn.onclick=()=>{ if(validStep()) goNextOrSubmit(); };

/* Submit survey */
function rewardCode(prefix="MDG"){
  const chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"; let c="";
  for(let i=0;i<6;i++) c+=chars[Math.floor(Math.random()*36)];
  return `${prefix}-${c}`;
}
submitBtn.onclick=async()=>{
  if(!validStep()) return;
  submitBtn.disabled=true; submitBtn.textContent='Submitting…';
  try{
    const code=rewardCode('MDG'); 
    document.getElementById('rewardCode').textContent=code;

    // push suggestion history
    pushHistory('cities', (surveyState.answers['q4_city']||'').trim());
    pushHistory('malls', (surveyState.answers['q4_mall']||'').trim());
    pushHistory('places', (surveyState.answers['q5_place']||'').trim());
    pushHistory('sources', (surveyState.answers['q2_other']||'').trim());

    const answersClean = normalizeAnswers(surveyState.answers);

    if(sb){
      const gateId = stepSurvey.dataset.gateId || null;
      const payload = { answers:answersClean, reward_code:code, ...answersClean };
      if(gateId){
        await sb.from('submissions').update(payload).eq('id', gateId);
      }else{
        await sb.from('submissions').insert([{
          brand:'Mendokoro/Yushoken', flow:'with_receipt', has_receipt:true,
          receipt_no:receiptEl.value.trim(), email:emailEl.value.trim(), name:nameEl.value.trim()||null,
          consent:dpaEl.checked, subscribed:promoEl.checked, ...payload
        }]);
      }
    }

    stepSurvey.style.display='none'; 
    stepReward.style.display='block';
  }catch(e){
    alert('Error saving. Please try again.');
    submitBtn.disabled=false; submitBtn.textContent='Submit →';
  }
};

/* Copy + Save coupon */
document.getElementById('copyBtn').onclick=async()=>{
  try{ await navigator.clipboard.writeText(document.getElementById('rewardCode').textContent); }catch{}
};
document.getElementById('saveImgBtn').onclick=()=> exportCoupon();

/* Export coupon as PNG (faint gyoza added) */
async function exportCoupon(){
  const canvas=document.getElementById('couponCanvas');
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,W,H);

  const grd=ctx.createRadialGradient(160,140,40,160,140,240);
  grd.addColorStop(0,'rgba(255,31,40,0.20)'); grd.addColorStop(1,'rgba(255,31,40,0)');
  ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(170,150,180,0,Math.PI*2); ctx.fill();
  const grd2=ctx.createRadialGradient(W-160,H-160,40,W-160,H-160,260);
  grd2.addColorStop(0,'rgba(255,31,40,0.20)'); grd2.addColorStop(1,'rgba(255,31,40,0)');
  ctx.fillStyle=grd2; ctx.beginPath(); ctx.arc(W-170,H-170,200,0,Math.PI*2); ctx.fill();

  roundedRect(ctx, 36,36, W-72, H-72, 34);
  ctx.save(); ctx.strokeStyle='#ff1f28'; ctx.lineWidth=6; ctx.setLineDash([18,14]); ctx.stroke(); ctx.restore();

  ctx.save(); ctx.globalCompositeOperation='destination-out';
  drawCircle(ctx, 36, H/2, 26); drawCircle(ctx, W-36, H/2, 26);
  ctx.restore();

  const logo = await loadImage('./assets/img/mendokorologo.png').catch(()=>null);
  if(logo){ const lw=260, lh=260*logo.height/logo.width; ctx.drawImage(logo, W/2 - lw/2, 80, lw, lh); }

  const gyoza = await loadImage('./assets/img/gyoza.png').catch(()=>null);
  if(gyoza){
    const gw = 360, gh = 360*gyoza.height/gyoza.width;
    ctx.save(); ctx.globalAlpha = 0.15;
    ctx.drawImage(gyoza, W-80-gw, 70, gw, gh);
    ctx.restore();
  }

  ctx.fillStyle='#151515'; ctx.textAlign='center';
  ctx.font='800 46px Montserrat, sans-serif'; ctx.fillText('FREE 3 PIECE GYOZA FROM US!', W/2, 360);
  ctx.font='700 20px Montserrat, sans-serif'; ctx.fillStyle='#6b7280';
  ctx.fillText('Show this at the truck to redeem • One-time use', W/2, 394);

  const code=document.getElementById('rewardCode').textContent || 'MDG-XXXXXX';
  const pillW = Math.max(380, ctx.measureText(code).width + 80);
  const pillX=W/2 - pillW/2, pillY=420, pillH=78, r=18;
  ctx.fillStyle='#fff5f6'; roundedRect(ctx, pillX, pillY, pillW, pillH, r); ctx.fill();
  ctx.save(); ctx.setLineDash([12,10]); ctx.lineWidth=3; ctx.strokeStyle='#ff1f28'; roundedRect(ctx, pillX, pillY, pillW, pillH, r); ctx.stroke(); ctx.restore();
  ctx.font='800 36px Montserrat, sans-serif'; ctx.fillStyle='#151515'; ctx.fillText(code, W/2, pillY+50);

  const url=canvas.toDataURL('image/png');
  const a=document.createElement('a');
  a.href=url; a.download=`mendokoro-coupon-${code}.png`;
  document.body.appendChild(a); a.click(); a.remove();
}

function roundedRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}
function drawCircle(ctx,x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
function loadImage(src){
  return new Promise((res,rej)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>res(im); im.onerror=rej; im.src=src; });
}
</script>
</body>
</html>
