<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mendokoro / Yushoken — Food Truck Survey</title>

<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --font:"Montserrat",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  --accent:#0e9ba4; 
  --accent-dk:#0c8a92;
  --ink:#101010; --muted:#6b7280; --paper:#fff; --bg:#fff; --line:#e5e7eb;
  --ease:cubic-bezier(.22,.61,.36,1); --header-h:64px;
  --coupon-red: var(--accent); /* now teal */
  --coupon-ink:#151515;
}

*{box-sizing:border-box}
html,body{height:100%;width:100%;max-width:100%;overflow-x:hidden}
body{
  margin:0;font-family:var(--font);color:var(--ink);background:var(--bg);
  line-height:1.6; opacity:0; transform:translateY(6px); animation:fadeIn .35s ease forwards;
}
body.lock{ overflow:hidden }
body:not(.lock){ overflow-y:auto }
@keyframes fadeIn{to{opacity:1;transform:none}}

/* ================== HEADER ================== */
.site-header{
  position:fixed;inset:0 0 auto 0;height:var(--header-h);display:none;align-items:center;z-index:4;
  background:#ffffffd9;border-bottom:1px solid var(--line);backdrop-filter:saturate(180%) blur(6px);opacity:0
}
.site-header.show{display:flex;animation:hdr .22s var(--ease) forwards}
@keyframes hdr{to{opacity:1}}
.nav{max-width:1200px;margin:0 auto;padding:0 16px;width:100%;display:flex;justify-content:space-between;align-items:center;height:100%}
.brand-img{height:32px}
.brand-right{text-align:right}
.brand-name{font:800 15px/1 var(--font)}
.brand-sub{font:800 11px/1 var(--font); color:var(--muted); letter-spacing:.06em; text-transform:uppercase}

/* ================== Subtle BG ================== */
.bg{position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden;
  background:radial-gradient(1200px 360px at 50% -120px, rgba(14,155,164,.10), transparent 65%);
}
.scroller{position:absolute; inset:0; width:200%; height:100%; display:flex; animation:fuji-x 90s linear infinite}
@keyframes fuji-x{from{transform:translateX(0)} to{transform:translateX(-50%)}}
.belt{position:relative; width:50%; height:100%}
.fuji{position:absolute; opacity:.08; filter:grayscale(1)}
.f1{top:4%;left:8%;width:60px;transform:rotate(-9deg)} .f2{top:9%;left:32%;width:66px;transform:rotate(8deg)}
.f3{top:2%;left:58%;width:62px;transform:rotate(-16deg)} .f4{top:8%;left:83%;width:68px;transform:rotate(12deg)}
.f5{top:24%;left:13%;width:66px;transform:rotate(6deg)} .f6{top:21%;left:46%;width:72px;transform:rotate(-14deg)}
.f7{top:23%;left:74%;width:56px;transform:rotate(14deg)} .f8{top:48%;left:9%;width:60px;transform:rotate(-7deg)}
.f9{top:44%;left:37%;width:72px;transform:rotate(18deg)} .f10{top:41%;left:63%;width:80px;transform:rotate(-20deg)}
.f11{top:46%;left:89%;width:62px;transform:rotate(10deg)} .f12{top:69%;left:16%;width:54px;transform:rotate(13deg)}
.f13{top:63%;left:42%;width:74px;transform:rotate(-9deg)} .f14{top:66%;left:69%;width:66px;transform:rotate(7deg)}
.f15{top:60%;left:93%;width:60px;transform:rotate(-15deg)} .f16{top:88%;left:27%;width:62px;transform:rotate(-8deg)}
.f17{top:86%;left:53%;width:60px;transform:rotate(16deg)} .f18{top:90%;left:80%;width:68px;transform:rotate(-5deg)}

/* subtle food plates in corners */
.food-bg{position:fixed; inset:0; pointer-events:none; z-index:0}
.food-bg img{position:absolute; user-select:none; filter:blur(1px) drop-shadow(0 18px 36px rgba(0,0,0,.12)); opacity:.22}
.food-bg .left-bowl{left:-80px; bottom:-60px; width:min(520px,70vw)}
.food-bg .right-gyoza{right:-60px; bottom:-40px; width:min(380px,55vw); transform:rotate(-6deg)}

/* ================== HERO ================== */
.hero{ position:relative; min-height:100dvh; display:grid; place-items:center; padding:28px 16px; text-align:center; overflow:hidden; }
.wrap{max-width:960px; margin:0 auto; display:grid; justify-items:center; position:relative; z-index:1}
.hero-logo{margin:0 0 10px; transform:translateY(6px) scale(.985); opacity:0; animation:logoIn .5s var(--ease) .05s forwards}
.hero-logo img{width:min(520px,78vw); height:auto; display:block; filter:drop-shadow(0 14px 24px rgba(0,0,0,.10))}
@keyframes logoIn{to{transform:none; opacity:1}}
.subtitle{font:800 clamp(13px,2.6vw,16px)/1.2 var(--font); color:var(--muted); opacity:0; transform:translateY(6px); animation:rise .45s ease .1s forwards}
.accent-underline{width:0; height:3px; margin:10px auto 0; background:linear-gradient(90deg,transparent,var(--accent),transparent); border-radius:999px; opacity:.95; animation:underline .6s ease .18s forwards}
@keyframes underline{to{width:220px}}
@keyframes rise{to{opacity:1; transform:none}}
.strap{display:inline-flex; gap:10px; align-items:center; margin:14px 0 20px; color:var(--accent); font-weight:800; font-size:12px; letter-spacing:.12em; text-transform:uppercase; padding:8px 16px; border:1px solid #cfeff3; border-radius:999px; background:#e9fbfd; opacity:0; transform:translateY(6px); animation:rise .45s ease .22s forwards}
.lead{color:#4b5563; font-size:clamp(15px,2.4vw,18px); max-width:650px; margin:0 auto 20px; opacity:0; transform:translateY(6px); animation:rise .45s ease .28s forwards}

/* CTA */
.cta{
  position:relative; isolation:isolate; display:inline-flex; align-items:center; gap:12px;
  padding:14px 28px; border-radius:16px; font:800 16px/1 var(--font); color:#fff; text-decoration:none;
  background:var(--accent); border:1px solid rgba(0,0,0,.06);
  box-shadow:0 16px 32px color-mix(in srgb,var(--accent) 28%, transparent);
  transition:transform .18s ease, box-shadow .18s ease, color .18s ease; overflow:hidden
}
.cta::after{content:""; position:absolute; inset:0; z-index:-1; background:var(--accent-dk); transform:scaleX(0); transform-origin:left center; transition:transform .35s ease; border-radius:inherit}
.cta:hover{transform:translateY(-1px); box-shadow:0 20px 40px color-mix(in srgb,var(--accent) 36%, transparent)}
.cta:hover::after{transform:scaleX(1)}

/* ================== FLOW ================== */
.container{display:none; min-height:100dvh; padding:calc(var(--header-h) + 16px) 16px 32px; position:relative; z-index:1;
  display:grid; place-items:center; align-content:center; justify-content:center;}
.shell{width:min(900px,100%)}
.panel{background:var(--paper); border:1px solid var(--line); border-radius:20px; box-shadow:0 16px 48px rgba(0,0,0,.08); overflow:hidden}

/* ================== Shared form styles ================== */
.section{padding:18px}
.grid{display:grid; gap:12px}
label{display:block;font:800 14px/1 var(--font);margin:16px 0 6px}
.req{ color:var(--accent); margin-left:4px }
input[type="text"], input[type="email"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);font-size:15px;background:#fff}
input::placeholder{color:#9aa2ae}
input[type="text"]:focus, input[type="email"]:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(14,155,164,.15)}
.row{display:flex; gap:12px; flex-wrap:wrap}
.row .col{flex:1 1 240px}
.small-hint{color:#6b7280; font-size:12px}

.checks{margin-top:10px; display:grid; gap:10px}
.check{display:flex; gap:10px; align-items:flex-start}
.check input{accent-color:var(--accent); width:16px; height:16px; margin-top:2px}
.check div{font-size:13px; line-height:1.45; color:#111}
.check small{color:#6b7280; display:block; margin-top:2px; font-size:11.5px}
.actions{display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:18px}
.hint{color:#6b7280; font-size:12px}
.foot{margin-top:14px; color:#6b7280; font-size:12px}
.err{ color:#b91c1c; font-size:12px; margin-top:8px; display:none }
.err.show{ display:block }

.survey-head{display:flex; align-items:center; gap:12px; position:sticky; top:0; background:var(--paper); padding:6px 2px 10px; z-index:2}
.stepchip{font:800 12px var(--font); color:#0b6f76; padding:6px 10px; border-radius:999px; background:#e9fbfd; border:1px solid #b9edf1}
.progress{flex:1; height:8px; background:#e6f6f7; border-radius:999px; overflow:hidden}
.bar{height:100%; width:0; background:linear-gradient(90deg,var(--accent),var(--accent-dk)); transition:width .25s var(--ease)}
.cardQ{ margin-top:8px; padding:18px; border:1px solid var(--line); border-radius:16px; background:#fff;
  box-shadow:0 6px 16px rgba(0,0,0,.05); animation:stepIn .24s var(--ease); }
.cardQ.card-nps,.cardQ.card-rating{padding:0;border:none;box-shadow:none;background:transparent}
@keyframes stepIn{ from{ opacity:0; transform:translateY(6px)} to{ opacity:1; transform:none}}
.qnum{font:800 12px var(--font); color:#0b6f76; letter-spacing:.08em; text-transform:uppercase; margin-bottom:6px}
.qtitle{margin:0 0 10px; font:800 clamp(18px,3.8vw,22px)/1.25 var(--font)}
.qhelp{color:#6b7280; font-size:13px; margin:-2px 0 10px}

.opt-grid{ --col-min:140px; display:grid; gap:10px; margin-top:6px;
  grid-template-columns: repeat(auto-fit, minmax(var(--col-min), 1fr));
  max-width:680px; margin-inline:auto; }
.opt{
  position:relative; isolation:isolate; display:flex; align-items:center; justify-content:center; text-align:center;
  border:1px solid var(--line); background:#fff; color:#111;
  padding:0 14px; border-radius:12px; font:800 14px var(--font); cursor:pointer;
  min-height:48px; overflow:hidden; word-break:break-word; white-space:normal; transition:.12s var(--ease);
}
.opt.opt-branch{flex-direction:column; gap:8px; padding:16px 14px; min-height:94px}
.opt.opt-branch .opt-brand-row{display:flex; align-items:center; gap:8px}
.opt.opt-branch .opt-brand-row .opt-logo{display:grid; place-items:center; height:26px; width:26px; border-radius:50%; background:#f0f9fa; padding:4px}
.opt.opt-branch .opt-brand-row .opt-logo img{max-height:18px; width:auto; object-fit:contain}
.opt.opt-branch .opt-brand-text{font:800 11px/1 var(--font); text-transform:uppercase; letter-spacing:.14em; color:#0f172a}
.opt.opt-branch .opt-branch-name{font:700 16px/1.2 var(--font); color:#0f172a}
.opt::after{content:""; position:absolute; inset:0; z-index:-1; background:var(--accent); transform:scaleX(0); transform-origin:left center; transition:transform .28s ease; border-radius:inherit}
.opt:hover{transform:translateY(-1px)}
.opt:hover::after{transform:scaleX(1)}
.opt:hover{color:#fff}
.opt.sel{color:#fff; border-color:var(--accent)}
.opt.sel::after{transform:scaleX(1)}

.clear-link{ margin-top:6px; font:700 12px var(--font); color:var(--accent); cursor:pointer; text-decoration:underline; display:none }

.slider-wrap{display:grid;gap:10px;justify-items:center;margin-top:12px}
.slider-value{font:800 18px/1 var(--font);color:var(--accent)}
.slider-scale{width:100%;display:flex;justify-content:space-between;font:700 11px/1 var(--font);color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
.slider-track{width:100%;max-width:640px;display:grid;gap:6px}
.slider-track input[type="range"]{--pct:0%;width:100%;appearance:none;height:6px;border-radius:999px;background:linear-gradient(90deg,var(--accent) 0%,var(--accent) var(--pct),#e6f6f7 var(--pct),#e6f6f7 100%);outline:none;transition:background .2s var(--ease)}
.slider-track input[type="range"]::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 0 0 4px rgba(14,155,164,.25);cursor:pointer;transition:transform .18s var(--ease)}
.slider-track input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.06)}
.slider-track input[type="range"]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 0 0 4px rgba(14,155,164,.25);cursor:pointer;transition:transform .18s var(--ease)}
.slider-track input[type="range"]::-moz-range-thumb:hover{transform:scale(1.06)}
.slider-track input[type="range"]::-ms-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 0 0 4px rgba(14,155,164,.25);cursor:pointer}
.slider-comment,.comment-wrap{width:100%;max-width:640px;display:none;gap:6px;margin-top:14px}
.slider-comment label,.comment-wrap label{font:700 13px/1.3 var(--font);color:#0f172a}
.slider-comment textarea,.comment-wrap textarea{width:100%;min-height:96px;border-radius:12px;border:1px solid var(--line);padding:12px 14px;font:400 14px/1.5 var(--font);resize:vertical;transition:border-color .18s var(--ease), box-shadow .18s var(--ease)}
.slider-comment textarea:focus,.comment-wrap textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(14,155,164,.15);outline:none}
.slider-comment textarea::placeholder,.comment-wrap textarea::placeholder{color:#9aa2ae}
.slider-value.placeholder{color:#94a3b8}

/* NPS (teal now) */
.slider-theme-nps .nps-shell{width:100%;max-width:640px;border-radius:28px;background:#fff;box-shadow:0 24px 60px rgba(14,155,164,.18);padding:28px 24px 30px;display:grid;gap:18px;border:1px solid rgba(14,155,164,.16);justify-items:center}
.slider-theme-nps .nps-question{font:800 18px/1.35 var(--font);color:#0f172a;text-align:center;margin:0}
.slider-theme-nps .nps-question-number{color:var(--accent);margin-right:6px}
.slider-theme-nps .nps-score{font:800 40px/1 var(--font);color:var(--accent);text-align:center}
.slider-theme-nps .nps-slider{position:relative;width:100%;padding:12px 0 12px}
.slider-theme-nps .nps-slider-track{position:relative;width:calc(100% - 36px);max-width:800px;margin:0 auto;padding-bottom:10px}
.slider-theme-nps .nps-slider-lane{position:relative;width:100%;height:12px;border-radius:999px;background:linear-gradient(90deg,#cfeff3 0%,#e8fbfd 100%)}
.slider-theme-nps .nps-slider-fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:inherit;background:linear-gradient(90deg,var(--accent) 0%,#55c7cf 100%);transition:width .2s var(--ease)}
.slider-theme-nps .nps-slider-thumb{
  position:absolute;top:50%;transform:translate(-50%,-50%);
  --thumb-size:clamp(38px,10vw,52px);
  width:var(--thumb-size);height:var(--thumb-size);border-radius:50%;
  background:var(--accent);border:4px solid #fff;box-shadow:0 14px 28px rgba(14,155,164,.22);
  display:grid;place-items:center;transition:transform .18s var(--ease);overflow:hidden
}
.slider-theme-nps .nps-slider-thumb img{width:68%;height:68%;object-fit:contain}
.slider-theme-nps .nps-slider-thumb .thumb-value,
.slider-theme-rating .rating-slider-thumb .thumb-value{display:none}
.slider-theme-nps .nps-slider-thumb:active{transform:translate(-50%,-50%) scale(1.05)}
.slider-theme-nps .nps-slider input[type="range"]{position:absolute;inset:-24px 26px -16px 26px;opacity:0;cursor:pointer;height:calc(100% + 40px)}
.slider-theme-nps .nps-ticks{width:100%;display:flex;justify-content:space-between;gap:6px;padding:0 26px;font:700 12px/1 var(--font);color:#94a3b8;text-transform:none;letter-spacing:.04em;max-width:800px;margin:0 auto}
.slider-theme-nps .nps-ticks span{position:relative;display:grid;justify-items:center;gap:4px;padding-top:10px;transition:color .18s var(--ease)}
.slider-theme-nps .nps-ticks span::before{content:"";position:absolute;top:0;left:50%;transform:translateX(-50%);width:2px;height:8px;border-radius:999px;background:#d0e9ec;transition:background .18s var(--ease),height .18s var(--ease)}
.slider-theme-nps .nps-ticks span.active{color:var(--accent)}
.slider-theme-nps .nps-ticks span.active::before{background:var(--accent);height:12px}
.slider-theme-nps .nps-followups{width:100%;display:grid;gap:16px;max-height:0;opacity:0;transform:translateY(8px);overflow:hidden;pointer-events:none;transition:opacity .24s var(--ease),transform .24s var(--ease),max-height .3s var(--ease)}
.slider-theme-nps .nps-followups.active{max-height:620px;opacity:1;transform:none;pointer-events:auto}
.slider-theme-nps .nps-followup{display:grid;gap:8px;opacity:0;transform:translateY(8px);max-height:0;overflow:hidden;pointer-events:none;transition:opacity .24s var(--ease),transform .24s var(--ease),max-height .3s var(--ease)}
.slider-theme-nps .nps-followup.is-visible{opacity:1;transform:none;max-height:320px;pointer-events:auto}
.slider-theme-nps .nps-followup label{font:700 14px/1.4 var(--font);color:#0f172a}
.slider-theme-nps .nps-followup textarea{width:100%;min-height:110px;border-radius:18px;border:2px solid #cfeff3;padding:16px;font:400 15px/1.5 var(--font);background:#fff;resize:vertical;transition:border-color .18s var(--ease), box-shadow .18s var(--ease)}
.slider-theme-nps .nps-followup textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(14,155,164,.18);outline:none}
.slider-theme-nps .nps-followup textarea::placeholder{color:#79bec3}

/* Rating slider */
.slider-theme-rating{width:100%;justify-items:stretch}
.slider-theme-rating .rating-shell{width:100%;max-width:640px;border-radius:28px;background:#fff;box-shadow:0 24px 60px rgba(14,155,164,.18);padding:28px 24px 30px;border:1px solid rgba(14,155,164,.16);display:grid;gap:18px;justify-items:center}
.slider-theme-rating .rating-question{margin:0;font:800 18px/1.35 var(--font);color:#0f172a;text-align:center}
.slider-theme-rating .rating-question-number{color:var(--accent);margin-right:6px}
.slider-theme-rating .rating-score{font:800 40px/1 var(--font);color:var(--accent)}
.slider-theme-rating .rating-score.is-empty{color:#cbd5e1}
.slider-theme-rating .rating-score-label{font:700 13px/1.3 var(--font);color:#0f172a;letter-spacing:.14em;text-transform:uppercase}
.slider-theme-rating .rating-score-label.is-empty{color:#94a3b8}
.slider-theme-rating .rating-slider{position:relative;width:100%;padding:12px 0 12px}
.slider-theme-rating .rating-slider-track{position:relative;width:calc(100% - 36px);max-width:800px;margin:0 auto;padding-bottom:10px}
.slider-theme-rating .rating-slider-lane{position:relative;width:100%;height:12px;border-radius:999px;background:linear-gradient(90deg,#d9f4f6 0%,#ecfbfd 100%)}
.slider-theme-rating .rating-slider-fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:inherit;background:linear-gradient(90deg,var(--accent) 0%,rgba(14,155,164,.65) 100%);transition:width .22s var(--ease)}
.slider-theme-rating .rating-slider-thumb{
  position:absolute;top:50%;transform:translate(-50%,-50%);
  --thumb-size:clamp(38px,10vw,52px);
  width:var(--thumb-size);height:var(--thumb-size);border-radius:50%;
  background:var(--accent);border:4px solid #fff;box-shadow:0 14px 28px rgba(14,155,164,.22);
  display:grid;place-items:center;transition:transform .18s var(--ease);overflow:hidden
}
.slider-theme-rating .rating-slider-thumb img{width:68%;height:68%;object-fit:contain;opacity:.95}
.slider-theme-rating .rating-slider-thumb:active{transform:translate(-50%,-50%) scale(1.04)}
.slider-theme-rating .rating-slider input[type="range"]{position:absolute;inset:-24px 26px -16px 26px;opacity:0;cursor:pointer;height:calc(100% + 40px)}
.slider-theme-rating .rating-ticks{width:100%;display:flex;justify-content:space-between;gap:6px;padding:0 26px;font:700 11px/1.2 var(--font);color:#6b7b8f;text-transform:none;letter-spacing:.08em;max-width:800px;margin:0 auto}
.slider-theme-rating .rating-ticks span{position:relative;display:grid;justify-items:center;gap:4px;padding-top:10px;white-space:nowrap;text-align:center;transition:color .18s var(--ease)}
.slider-theme-rating .rating-ticks span::before{content:"";position:absolute;top:0;left:50%;transform:translateX(-50%);width:2px;height:8px;border-radius:999px;background:#d8eef0;transition:background .18s var(--ease),height .18s var(--ease)}
.slider-theme-rating .rating-ticks span.active{color:var(--accent)}
.slider-theme-rating .rating-ticks span.active::before{background:var(--accent);height:12px}
.slider-theme-rating .rating-ticks span:first-child{align-self:flex-start}
.slider-theme-rating .rating-ticks span:last-child{align-self:flex-start}
.slider-theme-rating .rating-followups{display:grid;gap:16px;margin-top:6px;max-height:0;opacity:0;transform:translateY(8px);overflow:hidden;pointer-events:none;transition:opacity .24s var(--ease),transform .24s var(--ease),max-height .3s var(--ease)}
.slider-theme-rating .rating-followups.active{max-height:620px;opacity:1;transform:none;pointer-events:auto}
.slider-theme-rating .rating-followup{display:grid;gap:8px;opacity:0;transform:translateY(8px);max-height:0;overflow:hidden;pointer-events:none;transition:opacity .24s var(--ease),transform .24s var(--ease),max-height .3s var(--ease)}
.slider-theme-rating .rating-followup.is-visible{opacity:1;transform:none;max-height:320px;pointer-events:auto}
.slider-theme-rating .rating-followup label{font:700 14px/1.35 var(--font);color:#0f172a}
.slider-theme-rating .rating-followup textarea{width:100%;min-height:110px;border-radius:20px;border:2px solid #cfeff3;padding:16px;font:400 15px/1.5 var(--font);background:#fff;resize:vertical;transition:border-color .18s var(--ease), box-shadow .18s var(--ease)}
.slider-theme-rating .rating-followup textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(14,155,164,.18);outline:none}
.slider-theme-rating .rating-followup textarea::placeholder{color:#79bec3}
.link-followup{margin-top:12px;padding:14px;border:1px solid var(--line);border-radius:12px;background:#f8ffff;display:grid;gap:8px;justify-items:flex-start}
.link-followup p{margin:0;font:700 13px/1.2 var(--font);color:#0b6f76}
.link-followup-list{display:flex;gap:12px;flex-wrap:wrap}
.link-followup-list a{font:700 13px/1 var(--font);color:var(--accent);text-decoration:none;border-bottom:1px solid transparent;padding-bottom:2px}
.link-followup-list a:hover{border-bottom-color:var(--accent)}

.controls{display:flex; gap:10px; justify-content:center; align-items:center; padding-top:12px; border-top:1px dashed var(--line); margin-top:14px}
.btn{
  position:relative; isolation:isolate;
  display:inline-block; padding:12px 18px; border-radius:12px; font:800 14px/1 var(--font); color:#fff;
  background:var(--accent); border:1px solid rgba(0,0,0,.06); cursor:pointer;
  box-shadow:0 10px 18px color-mix(in srgb,var(--accent) 38%, transparent);
  overflow:hidden; transition:transform .18s ease, box-shadow .18s ease, color .18s ease;
}
.btn::after{content:""; position:absolute; inset:0; z-index:-1; background:var(--accent-dk); transform:scaleX(0); transform-origin:left center; transition:transform .35s ease; border-radius:inherit}
.btn:hover{transform:translateY(-1px)}
.btn:hover::after{transform:scaleX(1)}
.btn.alt{background:#e9fbfd; color:#0b6f76; box-shadow:none}
.btn[disabled]{opacity:.55; cursor:not-allowed; filter:grayscale(.35)}
.state{color:#0b6f76; font-size:12px; text-align:center; min-height:1em; margin-top:4px}

/* Reward ticket (now teal outline) */
.section.reward-section{padding:18px}
.coupon-wrap{ display:grid; gap:16px; justify-items:center; text-align:center; margin:8px 0 6px; padding-inline:12px }
.ticket{
  position:relative; width:100%; max-width:680px; margin:0 auto; background:#fff; border-radius:20px; 
  box-shadow:0 18px 60px rgba(0,0,0,.16); padding:22px; overflow:hidden;
  outline:2px dashed var(--coupon-red); outline-offset:-8px;
  --cut:22px;
  background:
    radial-gradient(circle var(--cut) at left 50%, transparent 99%, #fff 100%) left center/var(--cut) 100% no-repeat,
    radial-gradient(circle var(--cut) at right 50%, transparent 99%, #fff 100%) right center/var(--cut) 100% no-repeat;
}
.ticket-head{ display:flex; gap:10px; align-items:center; justify-content:center; }
.ticket-head img{ height:40px }
.ticket-sub{ color:#6b7280; font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing:.14em; }
.ticket-title{ font:800 clamp(18px,4.2vw,26px)/1.1 var(--font); margin:10px 0 2px; }
.ticket-code{
  font:800 clamp(22px,5vw,30px)/1 var(--font); letter-spacing:2px; color:var(--coupon-ink);
  background:#e7fbfd; border:2px dashed var(--coupon-red); padding:12px 16px; border-radius:14px; display:inline-block; margin-top:10px;
}
.ticket-foot{ color:#6b7280; font-size:12px; margin-top:8px }
.coupon-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:4px }
.ticket-ill{ position:absolute; right:-6px; top:16px; width:160px; opacity:.18; transform:rotate(-6deg); pointer-events:none }

/* Loading overlay */
.overlay{
  position:fixed; inset:0; display:grid; place-items:center;
  background:rgba(255,255,255,.65); backdrop-filter:blur(8px) saturate(120%);
  opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:50;
}
.overlay.show{ opacity:1; pointer-events:auto; }
.loader{ display:grid; place-items:center; gap:12px; text-align:center; color:#334155; font-weight:700; font-size:14px }
.loader-logos{display:grid; gap:10px; justify-items:center}
.loader-logos img{ height:52px; width:auto; filter:drop-shadow(0 10px 18px rgba(0,0,0,.16)); animation:pulse 1.2s ease-in-out infinite }
@keyframes pulse{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.06) } }

/* Typeahead dropdown */
.typeahead{ position:relative; }
.ta-list{
  position:absolute; left:0; right:0; top:calc(100% + 4px);
  background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.08);
  max-height:220px; overflow:auto; z-index:10; display:none;
}
.ta-item{ padding:10px 12px; cursor:pointer; font-size:14px; }
.ta-item:hover, .ta-item.active{ background:#e9fbfd; color:#0b6f76; }
</style>
</head>
<body class="lock">

<!-- Background -->
<div class="bg" aria-hidden="true">
  <div class="scroller">
    <div class="belt">
      <img class="fuji f1" src="./assets/img/mtfuji.png" alt=""><img class="fuji f2" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f3" src="./assets/img/mtfuji.png" alt=""><img class="fuji f4" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f5" src="./assets/img/mtfuji.png" alt=""><img class="fuji f6" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f7" src="./assets/img/mtfuji.png" alt=""><img class="fuji f8" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f9" src="./assets/img/mtfuji.png" alt=""><img class="fuji f10" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f11" src="./assets/img/mtfuji.png" alt=""><img class="fuji f12" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f13" src="./assets/img/mtfuji.png" alt=""><img class="fuji f14" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f15" src="./assets/img/mtfuji.png" alt=""><img class="fuji f16" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f17" src="./assets/img/mtfuji.png" alt=""><img class="fuji f18" src="./assets/img/mtfuji.png" alt="">
    </div>
    <div class="belt">
      <img class="fuji f1" src="./assets/img/mtfuji.png" alt=""><img class="fuji f2" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f3" src="./assets/img/mtfuji.png" alt=""><img class="fuji f4" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f5" src="./assets/img/mtfuji.png" alt=""><img class="fuji f6" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f7" src="./assets/img/mtfuji.png" alt=""><img class="fuji f8" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f9" src="./assets/img/mtfuji.png" alt=""><img class="fuji f10" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f11" src="./assets/img/mtfuji.png" alt=""><img class="fuji f12" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f13" src="./assets/img/mtfuji.png" alt=""><img class="fuji f14" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f15" src="./assets/img/mtfuji.png" alt=""><img class="fuji f16" src="./assets/img/mtfuji.png" alt="">
      <img class="fuji f17" src="./assets/img/mtfuji.png" alt=""><img class="fuji f18" src="./assets/img/mtfuji.png" alt="">
    </div>
  </div>
</div>

<!-- subtle food plates fixed in corners -->
<div class="food-bg" aria-hidden="true">
  <img class="left-bowl" src="./assets/img/mendo-ramen.png" alt="">
  <img class="right-gyoza" src="./assets/img/gyoza.png" alt="">
</div>

<!-- Header -->
<header id="hdr" class="site-header" aria-hidden="true">
  <nav class="nav">
    <img class="brand-img" src="./assets/img/nhlogo.png" alt="Nippon Hasha">
    <div class="brand-right">
      <div class="brand-name">Mendokoro • Yushoken</div>
      <div class="brand-sub">Food Truck Survey</div>
    </div>
  </nav>
</header>

<!-- HERO -->
<section class="hero" id="hero">
  <div class="wrap">
    <div class="hero-logo"><img src="./assets/img/mendokorologo.png" alt="Mendokoro Ramenba"></div>
    <div class="hero-logo"><img src="./assets/img/yushokenlogo.png" alt="Ramen Yushoken"></div>
    <div class="subtitle">A Nippon Hasha Brand</div>
    <div class="accent-underline" aria-hidden="true"></div>
    <div class="strap">Food Truck Survey</div>
    <p class="lead">Help us improve and get a small treat from us on your next visit!</p>
    <a href="#start" id="startBtn" class="cta">Start Survey →</a>
  </div>
</section>

<!-- FLOW -->
<div class="container" id="start" style="display:none">
  <main class="shell panel">
    <!-- Gate -->
    <section id="stepGate" class="section" role="form">
      <h1 style="font:800 clamp(20px,3.6vw,26px)/1.18 var(--font); margin:2px 0">Start your survey</h1>
      <p class="hint" style="margin-bottom:10px">Enter your details to proceed.</p>

      <form id="gateForm" novalidate>
        <label for="receipt">Receipt Number<span class="req" aria-hidden="true">*</span></label>
        <input id="receipt" name="receipt" type="text" inputmode="numeric" maxlength="18"
               placeholder="FTPU-123456-789012" required aria-describedby="receiptHelp receiptErr">
        <div id="receiptHelp" class="hint">Format: <code>FTPU-000000-000000</code>. Only numbers after the prefix.</div>
        <div id="receiptErr" class="err">Invalid receipt format or brand code.</div>

        <div class="row">
          <div class="col">
            <label for="email">Email<span class="req" aria-hidden="true">*</span></label>
            <input id="email" name="email" type="email" placeholder="you@example.com" required>
          </div>
          <div class="col">
            <label for="name">Name <span class="hint">(optional)</span></label>
            <input id="name" name="name" type="text" placeholder="Juan Dela Cruz">
          </div>
        </div>

        <div class="checks" aria-label="Consent options">
          <label class="check">
            <input id="dpa" name="dpa" type="checkbox" required>
            <div>I agree to the Philippine Data Privacy Act and consent to the processing of my responses for service improvement.<small>Required to proceed.</small></div>
          </label>
          <label class="check">
            <input id="promo" name="promo" type="checkbox">
            <div>I’d like to receive emails about promotions and updates.<small>Optional.</small></div>
          </label>
        </div>

        <div class="actions">
          <button id="continueBtn" class="cta" type="submit" disabled>Continue →</button>
          <span id="stateMsg" class="hint" aria-live="polite">Fill the required fields to continue.</span>
        </div>

        <p class="foot">By continuing, you acknowledge Nippon Hasha’s policies and terms of service.</p>
      </form>
    </section>

    <!-- Survey -->
    <section id="stepSurvey" class="section" style="display:none">
      <div class="survey-head">
        <div id="stepChip" class="stepchip">Question 1 of 12</div>
        <div class="progress"><div id="bar" class="bar"></div></div>
      </div>

      <div id="qwrap"></div>

      <div class="controls">
        <button id="backBtn" class="btn alt" type="button">← Back</button>
        <button id="nextBtn" class="btn" type="button" disabled>Next →</button>
        <button id="submitBtn" class="btn" type="button" style="display:none" disabled>Submit →</button>
      </div>
      <div id="stateQ" class="state" aria-live="polite"></div>
    </section>

    <!-- Reward -->
    <section id="stepReward" class="section reward-section" style="display:none">
      <div class="coupon-wrap">
        <div class="ticket" id="ticket">
          <img class="ticket-ill" src="./assets/img/gyoza.png" alt="">
          <div class="ticket-head">
            <img src="./assets/img/mendokorologo.png" alt="Mendokoro">
            <img src="./assets/img/yushokenlogo.png" alt="Yushoken">
          </div>
          <div class="ticket-sub">A Nippon Hasha Brand</div>
          <div class="ticket-title">Thank you for your time! Use this code to claim your FREE 3-PIECE GYOZA on us!</div>
          <div id="rewardCode" class="ticket-code">—</div>
          <div class="ticket-foot">Show this at the truck to redeem • One-time use</div>
        </div>
        <div class="coupon-actions">
          <button id="copyBtn" class="btn" type="button">Copy Code</button>
          <button id="saveImgBtn" class="btn" type="button">Save Coupon</button>
        </div>
      </div>
      <canvas id="couponCanvas" width="1200" height="640" style="display:none"></canvas>
    </section>
  </main>
</div>


<!-- Loading overlay -->
<div class="overlay" id="overlay">
  <div class="loader">
    <div class="loader-logos">
      <img src="./assets/img/mendokorologo.png" alt="Mendokoro Ramenba">
      <img src="./assets/img/yushokenlogo.png" alt="Ramen Yushoken">
    </div>
    Storing your details…
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

<!-- QUESTIONS (updated) -->
<script id="QUESTIONS_JSON" type="application/json">[
  {"id":"q1","type":"buttons","prompt":"Did you enjoy your Blue Truck Pop-up experience?","options":["Yes","No"]},

  {"id":"q2","type":"buttons","prompt":"Where did you hear about our Blue Truck Pop-up?","options":["Official Website","Official Social Media Pages","Content Creator / Influencer","Friend or Family","On-site Discovery","Mall or Event Poster","Others"],"otherText":true,"otherId":"q2_other","otherPlaceholder":"Please specify"},

  {"id":"q3","type":"buttons","prompt":"Have you been to one of our branches before?","options":["Yes","No"]},
  {"id":"q3a","type":"buttons","prompt":"Which branch did you go to?","options":["Cebu","Ortigas","Pasay","Rockwell","Alabang","Panay","Katipunan","None / Not applicable"],"showIf":{"id":"q3","equals":"Yes"}},

  {"id":"q4","type":"buttons","prompt":"Where do you want to see our Blue Truck next?","options":["City","Mall"],"followups":[
      {"when":"City","id":"q4_city","type":"text","placeholder":"Type a city in the Philippines","suggestKey":"cities","required":true},
      {"when":"Mall","id":"q4_mall","type":"text","placeholder":"Which mall?","suggestKey":"malls","required":true}
  ]},

  {"id":"q5","type":"buttons","prompt":"Are you working near or living near here?","options":["Working","Living"],"followups":[
      {"when":"Working","id":"q5_place","type":"text","placeholder":"Which office / company?","suggestKey":"places","required":true},
      {"when":"Living","id":"q5_place","type":"text","placeholder":"Which village / subdivision?","suggestKey":"places","required":true}
  ]},

  {"id":"q7_food","type":"slider","prompt":"How would you rate our food today?","min":1,"max":10,"step":1,"theme":"rating",
    "scaleLabels":{"1":"1","10":"10"},
    "buckets":[
      {"id":"q7_food_low","min":1,"max":4,"label":"What went wrong with the food?","placeholder":"Let us know what to improve."},
      {"id":"q7_food_mid","min":5,"max":7,"label":"What could make the food better?","placeholder":"Share your suggestions…"},
      {"id":"q7_food_high","min":8,"max":10,"label":"Awesome! What did you love most?","placeholder":"Tell us your highlight…"}
    ]},

  {"id":"q7_service","type":"slider","prompt":"How would you rate our service today?","min":1,"max":10,"step":1,"theme":"rating",
    "scaleLabels":{"1":"1","10":"10"},
    "buckets":[
      {"id":"q7_service_low","min":1,"max":4,"label":"What went wrong with the service?","placeholder":"Let us know what to improve."},
      {"id":"q7_service_mid","min":5,"max":7,"label":"How can we serve you better?","placeholder":"Share your suggestions…"},
      {"id":"q7_service_high","min":8,"max":10,"label":"Amazing! What stood out in our service?","placeholder":"Tell us your highlight…"}
    ]},

  {"id":"q7_price","type":"slider","prompt":"How would you rate the value for price today?","min":1,"max":10,"step":1,"theme":"rating",
    "scaleLabels":{"1":"1","10":"10"},
    "buckets":[
      {"id":"q7_price_low","min":1,"max":4,"label":"What felt off about the value?","placeholder":"Tell us what didn’t feel worth it."},
      {"id":"q7_price_mid","min":5,"max":7,"label":"How could we give you better value?","placeholder":"Share your ideas…"},
      {"id":"q7_price_high","min":8,"max":10,"label":"Great! What made it worth it?","placeholder":"We’d love to know."}
    ]},

  {"id":"q8","type":"slider","prompt":"How likely is it that you would recommend this pop-up to others?","min":1,"max":10,"step":1,"labels":{"min":"Not Likely","max":"Extremely Likely"},"theme":"nps","buckets":[
      {"id":"q8_detractor","min":0,"max":6,"label":"What can we do better to improve your satisfaction?","placeholder":"Your feedback…"},
      {"id":"q8_passive","min":7,"max":8,"label":"What would make you more likely to recommend us?","placeholder":"Price, portion, taste, service…"},
      {"id":"q8_promoter","min":9,"max":10,"label":"What is the main reason you would recommend us?","placeholder":"Your reason…"}
  ]},

  {"id":"q10_return","type":"slider","prompt":"Based on your visit, how likely are you to dine with us again soon?","min":1,"max":10,"step":1,"labels":{"min":"Not Likely","max":"Very Likely"},"theme":"nps","buckets":[
      {"id":"q10_return_low","min":1,"max":4,"label":"What could we improve for next time?","placeholder":"Your feedback…"},
      {"id":"q10_return_mid","min":5,"max":7,"label":"What would make you more eager to dine again?","placeholder":"Suggestions…"},
      {"id":"q10_return_high","min":8,"max":10,"label":"Awesome! Any plans or dishes you're excited to try next?","placeholder":"Share with us…"}
  ]},

  {"id":"q9","type":"buttons","prompt":"Which cuisines are you most interested in?","options":["Filipino","Chinese","Italian","Mexican","South American","Japanese"],"multi":true,"otherText":true,"otherId":"q9_other","otherPlaceholder":"Other cuisine (please specify)","commentId":"q9_comment","commentPlaceholder":"Optional: tell us about your favorite dishes."},

  {"id":"q10","type":"buttons","prompt":"Would you love to hear more about us and where we are headed?","options":["Yes","No"],"followups":[
      {"when":"Yes","type":"links","text":"Follow us for updates:","links":[
        {"label":"Facebook","href":"https://www.facebook.com/mendokororamen"},
        {"label":"Instagram","href":"https://www.instagram.com/mendokoro_ramenba"}
      ]}
  ]}
]</script>

<script>
/* ---------- Supabase ---------- */
const SUPABASE_URL = 'https://xkzicpfxlvgovugumspr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhremljcGZ4bHZnb3Z1Z3Vtc3ByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyODI1MzAsImV4cCI6MjA3Mjg1ODUzMH0.8xykX92QwVWccQyOz60ONb_CirdbGcKvQD8FjO8RJrA';
const sb = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- Landing → Flow ---------- */
const hero=document.getElementById('hero'), container=document.querySelector('.container'), hdr=document.getElementById('hdr');
document.getElementById('startBtn').addEventListener('click',e=>{
  e.preventDefault();
  hero.style.transition='opacity .22s var(--ease), transform .22s var(--ease)';
  hero.style.opacity='0'; hero.style.transform='translateY(-6px)';
  setTimeout(()=>{
    hero.style.display='none';
    container.style.display='grid';
    hdr.classList.add('show'); hdr.removeAttribute('aria-hidden');
    document.body.classList.remove('lock');
  }, 180);
});

/* ---------- Gate logic ---------- */
const gateForm=document.getElementById('gateForm');
const receiptEl=document.getElementById('receipt'), emailEl=document.getElementById('email'), nameEl=document.getElementById('name');
const dpaEl=document.getElementById('dpa'), promoEl=document.getElementById('promo');
const continueBtn=document.getElementById('continueBtn'), stateMsg=document.getElementById('stateMsg'), receiptErr=document.getElementById('receiptErr');
const overlay=document.getElementById('overlay');

(function(){
  const prefix='FTPU-';
  const pattern = /^FTPU-\d{6}-\d{6}$/;
  let receiptDirty=false;

  function ensurePrefix(val){
    return val.startsWith(prefix) ? val : prefix + val.replace(/^FTPU-?/, '');
  }

  function formatReceipt(raw){
    const digits = raw.replace(/[^0-9]/g,'').slice(0,12);
    const first = digits.slice(0,6);
    const second = digits.slice(6,12);
    let out = prefix;
    if(first.length){
      out += first;
      if(first.length===6) out += '-';
    }
    if(second.length){
      out += second;
    }
    return out;
  }

  function validateReceipt(forceShow=false){
    const v = receiptEl.value.trim();
    const ok = pattern.test(v);
    receiptEl.setCustomValidity(ok ? '' : 'Format must be FTPU-000000-000000.');
    const showErr = forceShow || receiptDirty;
    receiptErr.classList.toggle('show', showErr && !ok);
    return ok;
  }

  function setFormatted(val){
    const formatted = formatReceipt(ensurePrefix(val));
    receiptEl.value = formatted;
  }

  setFormatted(receiptEl.value || prefix);
  receiptEl.addEventListener('focus', ()=>{
    if(receiptEl.selectionStart < prefix.length){
      receiptEl.setSelectionRange(prefix.length, prefix.length);
    }
  });

  receiptEl.addEventListener('keydown', e=>{
    if((e.key==='Backspace' || e.key==='Delete') && receiptEl.selectionStart <= prefix.length){
      e.preventDefault();
      receiptEl.setSelectionRange(prefix.length, prefix.length);
    }
  });

  receiptEl.addEventListener('input', ()=>{
    receiptDirty = true;
    const rawVal = receiptEl.value;
    const caretPos = receiptEl.selectionStart ?? rawVal.length;
    const digitsBeforeCaret = rawVal.slice(0, caretPos).replace(/[^0-9]/g, '').length;

    setFormatted(rawVal);

    const totalDigits = Math.min(digitsBeforeCaret, 12);
    const hyphenOffset = totalDigits >= 6 ? 1 : 0;
    const desiredCaret = prefix.length + totalDigits + hyphenOffset;
    const maxCaret = Math.max(prefix.length, Math.min(receiptEl.value.length, desiredCaret));

    receiptEl.setSelectionRange(maxCaret, maxCaret);
    validateReceipt(); updateGate();
  });
  receiptEl.addEventListener('blur', ()=>{
    receiptDirty = true;
    validateReceipt(true);
    updateGate();
  });

  emailEl.addEventListener('input', ()=>{ emailEl.setCustomValidity(''); updateGate(); });
  emailEl.addEventListener('invalid', ()=>{
    if(emailEl.validity.typeMismatch || emailEl.validity.valueMissing){
      emailEl.setCustomValidity('Please enter a valid email (e.g., you@example.com).');
    }
  });

  dpaEl.addEventListener('change', updateGate);

  function updateGate(){
    const okRec = validateReceipt();
    const okEmail = emailEl.validity.valid;
    const okDpa = dpaEl.checked;
    const ok = okRec && okEmail && okDpa;
    continueBtn.disabled = !ok;
    if(ok){
      stateMsg.textContent = 'All set! You can now start your survey.';
    }else{
      const issues=[];
      if(!okRec) issues.push('your receipt number');
      if(!okEmail) issues.push('a valid email');
      if(!okDpa) issues.push('the privacy consent checkbox');
      const formatIssues = (items)=>{
        if(items.length<=1) return items[0] || '';
        if(items.length===2) return `${items[0]} and ${items[1]}`;
        return `${items.slice(0,-1).join(', ')}, and ${items[items.length-1]}`;
      };
      stateMsg.textContent = `Please complete ${formatIssues(issues)}.`;
    }
  }
  document.addEventListener('DOMContentLoaded', updateGate);
})();

/* ---------- Typeahead ---------- */
const PH_CITIES = [
  "Caloocan","Las Piñas","Makati","Malabon","Mandaluyong","Manila","Marikina","Muntinlupa","Navotas","Parañaque","Pasay","Pasig","Quezon City","San Juan","Taguig","Valenzuela","Pateros",
  "Alaminos","Angeles","Antipolo","Bacoor","Balanga","Batac","Batangas City","Baguio","Cabanatuan","Cabuyao","Candon","Cauayan","Cavite City","Dagupan","Dasmariñas","Gapan","General Trias","Iriga","Laoag","Legazpi","Ligao","Lipa","Lucena","Malolos","Meycauayan","Naga","Olongapo","Palayan","Puerto Princesa","San Carlos (Pangasinan)","San Fernando (La Union)","San Fernando (Pampanga)","San Jose (Nueva Ecija)","San Jose del Monte","San Pablo","Santa Rosa","Santiago","Sorsogon City","Tabuk","Tacurong","Tarlac City","Tayabas","Trece Martires","Vigan",
  "Bacolod","Bago","Bais","Bayawan","Baybay","Borongan","Calbayog","Catbalogan","Cebu City","Danao","Dumaguete","Guihulngan","Iloilo City","Kabankalan","Kananga","Lapu-Lapu","Maasin","Mandaue","Ormoc","Passi","Roxas City","Silay","Sipalay","Tagbilaran","Tacloban","Talisay (Cebu)","Talisay (Negros Occidental)","Toledo","Victorias",
  "Butuan","Cabadbaran","Cagayan de Oro","Cotabato City","Davao City","Digos","Dipolog","Dapitan","El Salvador","Gingoog","General Santos","Iligan","Isabela City","Kidapawan","Koronadal","Mati","Malaybalay","Marawi","Oroquieta","Ozamiz","Pagadian","Panabo","Samal","San Carlos (Negros Occidental)","Surigao City","Tagum","Tangub","Tandag","Valencia","Zamboanga City"
];

const PH_MALLS = [
  "SM Mall of Asia","SM Megamall","SM North EDSA","SM Aura Premier","SM Seaside Cebu","SM City Cebu","SM City Clark","SM City Pampanga",
  "Glorietta","Greenbelt","Ayala Malls Manila Bay","Ayala Malls Vertis North","Ayala Malls Trinoma","Ayala Center Cebu","Ayala Abreeza",
  "Uptown Mall BGC","Market! Market!","Bonifacio High Street","Venice Grand Canal Mall",
  "Robinsons Galleria","Robinsons Magnolia","Robinsons Manila","Robinsons Galleria Cebu",
  "Power Plant Mall","Shangri-La Plaza","Estancia Mall","Santolan Town Plaza",
  "Festival Mall","Alabang Town Center","Evia Lifestyle Center","Vista Mall Taguig",
  "Harbor Point Subic","Marquee Mall","Ayala Malls Solenad","Ayala Malls Circuit"
];

const BRANCH_LOGO_INFO = {
  "Cebu":{
    label:"Cebu",
    brandLabel:"Ramen Yushoken",
    logos:[{src:"./assets/img/yushokenlogo.png",alt:"Ramen Yushoken"}]
  },
  "Ortigas":{
    label:"Ortigas",
    brandLabel:"Mendokoro Ramenba",
    logos:[{src:"./assets/img/mendokorologo.png",alt:"Mendokoro Ramenba"}]
  },
  "Pasay":{
    label:"Pasay",
    brandLabel:"Mendokoro Ramenba",
    logos:[{src:"./assets/img/mendokorologo.png",alt:"Mendokoro Ramenba"}]
  },
  "Rockwell":{
    label:"Rockwell",
    brandLabel:"Mendokoro Ramenba",
    logos:[{src:"./assets/img/mendokorologo.png",alt:"Mendokoro Ramenba"}]
  },
  "Alabang":{
    label:"Alabang",
    brandLabel:"Mendokoro · Yushoken",
    logos:[
      {src:"./assets/img/mendokorologo.png",alt:"Mendokoro Ramenba"},
      {src:"./assets/img/yushokenlogo.png",alt:"Ramen Yushoken"}
    ]
  },
  "Panay":{
    label:"Panay",
    brandLabel:"Mendokoro Ramenba",
    logos:[{src:"./assets/img/mendokorologo.png",alt:"Mendokoro Ramenba"}]
  },
  "Katipunan":{
    label:"Katipunan",
    brandLabel:"Mendokoro Ramenba",
    logos:[{src:"./assets/img/mendokorologo.png",alt:"Mendokoro Ramenba"}]
  }
};

function attachTypeahead(input, list, onPick){
  const wrap = document.createElement('div');
  wrap.className = 'typeahead';
  input.parentNode.insertBefore(wrap, input);
  wrap.appendChild(input);
  const ul = document.createElement('div'); ul.className='ta-list'; wrap.appendChild(ul);
  let active = -1;

  function render(q){
    const qv = q.trim().toLowerCase();
    const seen = new Set();
    const fromHistory = (suggestHistory[input.dataset.suggestKey]||[]).filter(x=>x && x.toLowerCase().startsWith(qv));
    const base = list.filter(x=>x.toLowerCase().includes(qv));
    const items = [...fromHistory, ...base].filter(x=>{ if(seen.has(x)) return false; seen.add(x); return true; }).slice(0,20);
    ul.innerHTML='';
    active = -1;
    if(!qv || items.length===0){ ul.style.display='none'; return; }
    items.forEach((txt,i)=>{
      const it=document.createElement('div'); it.className='ta-item'; it.textContent=txt;
      it.addEventListener('mousedown', e=>{ e.preventDefault(); pick(txt); });
      ul.appendChild(it);
    });
    ul.style.display='block';
  }
  function highlight(){
    [...ul.children].forEach((c,i)=> c.classList.toggle('active', i===active));
  }
  function pick(val){
    input.value = val;
    ul.style.display='none';
    onPick?.(val);
  }

  input.addEventListener('input', ()=> render(input.value));
  input.addEventListener('focus', ()=> render(input.value));
  input.addEventListener('blur', ()=> setTimeout(()=>ul.style.display='none', 100));
  input.addEventListener('keydown', e=>{
    const n = ul.children.length;
    if(!n) return;
    if(e.key==='ArrowDown'){ active = (active+1)%n; highlight(); e.preventDefault(); }
    else if(e.key==='ArrowUp'){ active = (active-1+n)%n; highlight(); e.preventDefault(); }
    else if(e.key==='Enter' && active>-1){ e.preventDefault(); pick(ul.children[active].textContent); }
  });
}

/* ---------- Survey model/rendering ---------- */
const QUESTIONS = JSON.parse(document.getElementById('QUESTIONS_JSON').textContent||'[]');
const stepSurvey=document.getElementById('stepSurvey'), stepGate=document.getElementById('stepGate'), stepReward=document.getElementById('stepReward');
const qwrap=document.getElementById('qwrap'), bar=document.getElementById('bar'), chip=document.getElementById('stepChip');
const nextBtn=document.getElementById('nextBtn'), backBtn=document.getElementById('backBtn'), submitBtn=document.getElementById('submitBtn'), stateQ=document.getElementById('stateQ');
const surveyState={idx:0,answers:{}};

function choiceValue(val){
  if(val && typeof val==='object'){
    if('value' in val) return val.value;
    if(Array.isArray(val.choices)) return val.choices;
    if('choice' in val) return val.choice;
    return '';
  }
  return val ?? '';
}
function isQuestionVisible(q){
  if(!q) return false;
  const cond=q.showIf;
  if(!cond) return true;
  const current=choiceValue(surveyState.answers[cond.id]);
  if(cond.equals!==undefined){
    const expected=Array.isArray(cond.equals)?cond.equals:[cond.equals];
    if(Array.isArray(current)) return current.some(val=>expected.includes(val));
    return expected.includes(current);
  }
  if(cond.notEquals!==undefined){
    const blocked=Array.isArray(cond.notEquals)?cond.notEquals:[cond.notEquals];
    if(Array.isArray(current)) return !current.some(val=>blocked.includes(val));
    return !blocked.includes(current);
  }
  if(cond.truthy){
    if(Array.isArray(current)) return current.length>0;
    return !!current;
  }
  if(cond.falsy){
    if(Array.isArray(current)) return current.length===0;
    return !current;
  }
  return true;
}
function pruneHiddenAnswers(sourceId){
  QUESTIONS.forEach(q=>{
    if(q.showIf && q.showIf.id===sourceId && !isQuestionVisible(q)){
      delete surveyState.answers[q.id];
      if(q.otherId) delete surveyState.answers[q.otherId];
      if(q.commentId) delete surveyState.answers[q.commentId];
      if(Array.isArray(q.followups)){
        q.followups.forEach(f=> delete surveyState.answers[f.id]);
      }
      if(Array.isArray(q.buckets)){
        q.buckets.forEach(b=> delete surveyState.answers[b.id]);
      }
    }
  });
}
function findNextVisibleIndex(startIdx,direction){
  let idx=startIdx+direction;
  while(idx>=0 && idx<QUESTIONS.length){
    if(isQuestionVisible(QUESTIONS[idx])) return idx;
    idx+=direction;
  }
  return idx;
}
function nearestVisibleIndex(idx){
  if(isQuestionVisible(QUESTIONS[idx])) return idx;
  const forward=findNextVisibleIndex(idx,1);
  if(forward>=0 && forward<QUESTIONS.length) return forward;
  const backward=findNextVisibleIndex(idx,-1);
  if(backward>=0 && backward<QUESTIONS.length) return backward;
  return 0;
}
function visibleQuestions(){
  return QUESTIONS.filter(isQuestionVisible);
}

/* local suggestion history */
const storeKey='mdk_suggest_history';
const suggestHistory=JSON.parse(localStorage.getItem(storeKey)||'{}');
function pushHistory(key,val){
  if(!key||!val) return;
  const arr = Array.isArray(suggestHistory[key]) ? suggestHistory[key] : [];
  if(!arr.includes(val)) arr.unshift(val);
  suggestHistory[key]=arr.slice(0,40);
  localStorage.setItem(storeKey, JSON.stringify(suggestHistory));
}

/* normalize for DB */
function normalizeAnswers(raw) {
  const out = {};
  const sliderVal = (val)=>{
    let candidate = val;
    if(val && typeof val==='object' && val.value!==undefined) candidate = val.value;
    const num = Number(candidate);
    return Number.isFinite(num) ? num : null;
  };
  const determineBucket = (value, buckets=[])=>{
    if(!Number.isFinite(value)) return null;
    return buckets.find(b=>{
      const min = Number.isFinite(b.min) ? b.min : -Infinity;
      const max = Number.isFinite(b.max) ? b.max : Infinity;
      return value>=min && value<=max;
    })?.id || null;
  };
  out.q1 = (raw.q1?.choice || raw.q1 || "").toString();
  out.q2_choice = (raw.q2?.choice || "").toString();
  out.q2_other  = (raw.q2_other || "").trim();
  out.q3 = (raw.q3?.choice || raw.q3 || "").toString();
  out.q3_branch = (raw.q3a?.choice || raw.q3a || "").toString();
  out.q4 = (raw.q4?.choice || raw.q4 || "").toString();
  out.q4_city = (raw.q4_city || "").trim();
  out.q4_mall = (raw.q4_mall || "").trim();
  out.q5 = (raw.q5?.choice || raw.q5 || "").toString();
  out.q5_place = (raw.q5_place || "").trim();

  out.q7_food = sliderVal(raw.q7_food);
  out.q7_service = sliderVal(raw.q7_service);
  out.q7_price = sliderVal(raw.q7_price);

  const q7FoodBucket = determineBucket(out.q7_food, [
    {id:'q7_food_low',min:1,max:2},
    {id:'q7_food_mid',min:3,max:4},
    {id:'q7_food_high',min:5,max:5}
  ]);
  const q7ServiceBucket = determineBucket(out.q7_service, [
    {id:'q7_service_low',min:1,max:2},
    {id:'q7_service_mid',min:3,max:4},
    {id:'q7_service_high',min:5,max:5}
  ]);
  const q7PriceBucket = determineBucket(out.q7_price, [
    {id:'q7_price_low',min:1,max:2},
    {id:'q7_price_mid',min:3,max:4},
    {id:'q7_price_high',min:5,max:5}
  ]);

  const pickComment = (bucketId)=> (bucketId ? (raw[bucketId] ?? '').toString().trim() : '');
  const q7FoodComment = pickComment(q7FoodBucket);
  const q7ServiceComment = pickComment(q7ServiceBucket);
  const q7PriceComment = pickComment(q7PriceBucket);

  out.q7_food_comment = q7FoodComment || null;
  out.q7_food_comment_type = q7FoodBucket;
  out.q7_service_comment = q7ServiceComment || null;
  out.q7_service_comment_type = q7ServiceBucket;
  out.q7_price_comment = q7PriceComment || null;
  out.q7_price_comment_type = q7PriceBucket;

  out.q8_nps = sliderVal(raw.q8);
  out.q10_return = sliderVal(raw.q10_return);

  const q8BucketId = determineBucket(out.q8_nps, [
    {id:'q8_detractor',min:0,max:6},
    {id:'q8_passive',min:7,max:8},
    {id:'q8_promoter',min:9,max:10}
  ]);
  const q10BucketId = determineBucket(out.q10_return, [
    {id:'q10_return_low',min:1,max:4},
    {id:'q10_return_mid',min:5,max:7},
    {id:'q10_return_high',min:8,max:10}
  ]);

  const npsComment = q8BucketId ? (raw[q8BucketId] ?? '').toString().trim() : '';
  const returnComment = q10BucketId ? (raw[q10BucketId] ?? '').toString().trim() : '';
  out.q8_comment = npsComment || null;
  out.q8_comment_type = q8BucketId;
  out.q10_return_comment = returnComment || null;
  out.q10_return_comment_type = q10BucketId;

  // Cuisines (multi)
  const q9Obj = raw.q9 && typeof raw.q9==='object' ? raw.q9 : {};
  const q9Choices = Array.isArray(q9Obj.choices) ? q9Obj.choices.filter(Boolean) : [];
  const q9Single = q9Obj.choice || (typeof raw.q9==='string' ? raw.q9 : '');
  out.q9_choices = q9Choices;
  const combined = q9Choices.length ? q9Choices.join(', ') : (q9Single ? q9Single.toString() : '');
  out.q9 = combined || null;
  const q9Other = (raw.q9_other || "").trim();
  out.q9_other = q9Other || null;
  out.q9_comment = (raw.q9_comment ?? '').toString().trim() || null;

  out.q10 = (raw.q10?.choice || raw.q10 || "").toString();
  return out;
}

function setProgress(){
  const visible=visibleQuestions();
  const current=QUESTIONS[surveyState.idx];
  const pos=Math.max(visible.findIndex(q=>q.id===current?.id),0);
  const total=Math.max(visible.length,1);
  chip.textContent=`Question ${Math.min(pos+1,total)} of ${total}`;
  bar.style.width=((pos+1)/total)*100+'%';
}
function validStep(){
  const q=QUESTIONS[surveyState.idx]; 
  if(!q) return false;
  const v=surveyState.answers[q.id];
  if(q.type==='text') return !!(v && String(v).trim()!=='');
  if(q.type==='buttons'){
    const selections = q.multi
      ? (Array.isArray(v?.choices) ? v.choices.filter(Boolean) : [])
      : (v && v.choice ? [v.choice] : []);
    if(selections.length===0) return false;

    if(q.otherText){
      const needsOther = q.multi ? selections.includes('Others') : selections[0]==='Others';
      if(needsOther){
        const otherRaw = surveyState.answers[q.otherId];
        const otherText = typeof otherRaw==='string' ? otherRaw.trim() : '';
        if(!otherText) return false;
      }
    }

    if(Array.isArray(q.followups)){
      const checkFollowup = (follow)=>{
        if(!follow.required) return true;
        const followVal = surveyState.answers[follow.id];
        const followText = typeof followVal==='string' ? followVal.trim() : '';
        return !!followText;
      };
      if(q.multi){
        const active = q.followups.filter(f=>selections.includes(f.when));
        if(active.length){
          return active.every(checkFollowup);
        }
      }else{
        const match = q.followups.find(f=>f.when===selections[0]);
        if(match) return checkFollowup(match);
      }
    }

    // buckets for 5-point buttons
    if(Array.isArray(q.buckets) && !q.multi){
      const picked = selections[0];
      const match = q.buckets.find(b => (b.when||[]).includes(picked));
      if(match && !(surveyState.answers[match.id]||'').toString().trim()){
        return false; // require bucket follow-up when visible
      }
    }

    return true;
  }
  if(q.type==='slider'){
    const val = (typeof v==='object' && v) ? v.value : v;
    if(val === undefined || val === null || val==='') return false;
    const numericVal = Number(val);
    if(Array.isArray(q.buckets) && q.bucketRequired && Number.isFinite(numericVal)){
      const activeBucket = q.buckets.find(bucket=>{
        const bMin = Number.isFinite(bucket.min) ? bucket.min : -Infinity;
        const bMax = Number.isFinite(bucket.max) ? bucket.max : Infinity;
        return numericVal>=bMin && numericVal<=bMax;
      });
      if(activeBucket){
        const followText = (surveyState.answers[activeBucket.id]||'').toString().trim();
        if(!followText) return false;
      }
    }
    return true;
  }
  return !!v;
}
function updateStepButtons(){
  const isValid = validStep();
  const nextIdx = findNextVisibleIndex(surveyState.idx, 1);
  const prevIdx = findNextVisibleIndex(surveyState.idx, -1);
  const last = nextIdx >= QUESTIONS.length;
  nextBtn.style.display = last ? 'none' : 'inline-block';
  submitBtn.style.display = last ? 'inline-block' : 'none';
  nextBtn.disabled = !isValid;
  submitBtn.disabled = !isValid;
  backBtn.style.display = prevIdx < 0 ? 'none' : 'inline-block';
  stateQ.textContent = isValid ? '' : 'Answer to continue.';
  setProgress();
}

function renderButtons(q){
  const wrap=document.createElement('div');
  const grid=document.createElement('div'); grid.className='opt-grid';
  wrap.appendChild(grid);

  const getSelected=()=>{
    const current=surveyState.answers[q.id];
    if(q.multi){
      return Array.isArray(current?.choices) ? current.choices : [];
    }
    return current?.choice || '';
  };
  const setSelected=(val)=>{
    if(q.multi){
      surveyState.answers[q.id]={choices:val};
    }else{
      surveyState.answers[q.id]={choice:val};
    }
  };
  const syncButtons=()=>{
    const selected=getSelected();
    [...grid.children].forEach(btn=>{
      const val=btn.dataset.value || btn.textContent.trim();
      const isSel=q.multi ? selected.includes(val) : selected===val;
      btn.classList.toggle('sel', isSel);
    });
  };

  (q.options||[]).forEach(opt=>{
    const value = typeof opt==='string' ? opt : String(opt?.value ?? opt);
    const b=document.createElement('button'); b.type='button'; b.className='opt'; b.dataset.value=value;
    if(q.id==='q3a'){
      const info=BRANCH_LOGO_INFO[value];
      if(info){
        b.classList.add('opt-branch');
        const logos=(info.logos||[]).map(logo=>`<span class="opt-logo"><img src="${logo.src}" alt="${logo.alt || info.brandLabel || 'Branch logo'}"></span>`).join('');
        const brandText=info.brandLabel ? `<span class="opt-brand-text">${info.brandLabel}</span>` : '';
        b.innerHTML=`<div class="opt-brand-row">${logos}${brandText}</div><div class="opt-branch-name">${info.label || value}</div>`;
      }else{
        b.textContent=value;
      }
    }else{
      b.textContent=value;
    }
    b.onclick=()=>{
      const val=b.dataset.value || value;
      if(q.multi){
        const selections=[...getSelected()];
        const idx=selections.indexOf(val);
        if(idx>-1) selections.splice(idx,1);
        else selections.push(val);
        setSelected(selections);
      }else{
        const curr=getSelected();
        // tap again to unselect (mobile-friendly)
        if(curr===val){ surveyState.answers[q.id]={choice:''}; } else { setSelected(val); }
      }
      pruneHiddenAnswers(q.id);
      syncButtons();
      refreshFollowups(q, wrap);
      toggleComment?.();
      updateStepButtons();
      clearLink.style.display = q.multi && getSelected().length ? 'inline-block' : 'none';
    };
    grid.appendChild(b);
  });
  syncButtons();

  // Clear selections (helps mobile)
  const clearLink=document.createElement('div');
  clearLink.className='clear-link';
  clearLink.textContent='Clear selections';
  clearLink.onclick=()=>{
    if(q.multi){ setSelected([]); } else { setSelected(''); }
    syncButtons(); refreshFollowups(q,wrap); toggleComment?.(); updateStepButtons(); clearLink.style.display='none';
  };
  wrap.appendChild(clearLink);

  // "Others" textbox
  if(q.otherText){
    const holder=document.createElement('div'); holder.style.marginTop='10px';
    const input=document.createElement('input');
    input.type='text'; input.placeholder=q.otherPlaceholder||'Please specify'; input.id=q.otherId;
    input.value = surveyState.answers[q.otherId] || '';
    input.addEventListener('input',()=>{ surveyState.answers[q.otherId]=input.value; updateStepButtons(); });
    holder.appendChild(input);
    const hint=document.createElement('div'); hint.className='small-hint'; hint.textContent='Shown only if “Others” is chosen.'; holder.appendChild(hint);
    wrap.appendChild(holder);
    function toggleOthers(){
      const selected=getSelected();
      const isOthers=q.multi ? selected.includes('Others') : selected==='Others';
      holder.style.display = isOthers ? 'block' : 'none';
    }
    toggleOthers(); wrap.toggleOthers=toggleOthers;
  }

  // followups area (also used for button buckets)
  const fbox=document.createElement('div'); fbox.style.marginTop='10px'; fbox.className='grid';
  wrap.appendChild(fbox);
  wrap.fbox=fbox;

  function refreshFollowups(q, wrap){
    wrap.fbox.innerHTML='';
    // links followup
    if(Array.isArray(q.followups) && !q.multi){
      const picked = surveyState.answers[q.id]?.choice;
      const f = q.followups.find(x=>x.when===picked);
      if(f){
        if(f.type==='links' && Array.isArray(f.links)){
          const box=document.createElement('div'); box.className='link-followup';
          const intro=document.createElement('p'); intro.textContent=f.text || 'Follow us here:';
          box.appendChild(intro);
          const list=document.createElement('div'); list.className='link-followup-list';
          f.links.forEach(link=>{
            const a=document.createElement('a'); a.href=link.href; a.target='_blank'; a.rel='noopener noreferrer';
            a.textContent=link.label || link.href;
            list.appendChild(a);
          });
          box.appendChild(list);
          wrap.fbox.appendChild(box);
        }else{
          // text followup with typeahead
          const label=document.createElement('label'); label.textContent=f.placeholder || 'Please specify';
          const fieldWrap=document.createElement('div'); fieldWrap.className='typeahead';
          const input=document.createElement('input'); input.type='text'; input.placeholder=f.placeholder||'Please specify';
          input.dataset.suggestKey = f.suggestKey || '';
          input.value = surveyState.answers[f.id]||'';
          input.addEventListener('input', ()=>{ surveyState.answers[f.id]=input.value; updateStepButtons(); });
          fieldWrap.appendChild(input); wrap.fbox.appendChild(label); wrap.fbox.appendChild(fieldWrap);

          if(f.suggestKey==='cities'){
            attachTypeahead(input, PH_CITIES, (v)=>{ surveyState.answers[f.id]=v; updateStepButtons(); });
          }else if(f.suggestKey==='malls'){
            attachTypeahead(input, PH_MALLS, (v)=>{ surveyState.answers[f.id]=v; updateStepButtons(); });
          }
        }
      }
    }

    // button buckets for 5-point scale (show the relevant textarea)
    if(Array.isArray(q.buckets) && !q.multi){
      const picked = (surveyState.answers[q.id]?.choice)||'';
      const match = q.buckets.find(b => (b.when||[]).includes(picked));
      if(match){
        const area=document.createElement('div'); area.className='nps-followup';
        const label=document.createElement('label'); label.setAttribute('for', match.id); label.textContent=match.label || 'Tell us more';
        const textarea=document.createElement('textarea'); textarea.id=match.id; textarea.placeholder=match.placeholder || 'Your feedback…';
        textarea.value = surveyState.answers[match.id] || '';
        textarea.addEventListener('input', ()=>{ surveyState.answers[match.id]=textarea.value; updateStepButtons(); });
        area.appendChild(label); area.appendChild(textarea);
        wrap.fbox.appendChild(area);
      }else{
        // clean any previous bucket answers if user switched choices
        (q.buckets||[]).forEach(b=> delete surveyState.answers[b.id]);
      }
    }

    wrap.toggleOthers?.();
  }
  wrap.refreshFollowups=()=>refreshFollowups(q,wrap);

  let commentWrap; let toggleComment;
  if(q.commentId){
    commentWrap=document.createElement('div'); commentWrap.className='comment-wrap';
    const label=document.createElement('label'); label.setAttribute('for', q.commentId); label.textContent=q.commentPrompt || 'Additional comments (optional)';
    const textarea=document.createElement('textarea'); textarea.id=q.commentId; textarea.placeholder=q.commentPlaceholder || 'Optional comment';
    textarea.value = surveyState.answers[q.commentId] || '';
    textarea.addEventListener('input', ()=>{ surveyState.answers[q.commentId]=textarea.value; });
    commentWrap.appendChild(label); commentWrap.appendChild(textarea);
    wrap.appendChild(commentWrap);

    toggleComment=()=>{
      const selected=getSelected();
      const hasChoice=q.multi ? selected.length>0 : !!selected;
      commentWrap.style.display = hasChoice ? 'grid' : 'none';
      if(!hasChoice){
        textarea.value='';
        delete surveyState.answers[q.commentId];
      }
    };
    toggleComment();
  }

  // initial render
  wrap.refreshFollowups?.();
  return wrap;
}

function renderSlider(q, displayIndex){
  const wrap=document.createElement('div'); wrap.className='slider-wrap';
  const isNps=q.theme==='nps';
  const isRating=q.theme==='rating';
  if(isNps) wrap.classList.add('slider-theme-nps');
  else if(isRating) wrap.classList.add('slider-theme-rating');
  else if(q.theme) wrap.classList.add(`slider-theme-${q.theme}`);

  const minRaw=parseFloat(q.min ?? '');
  const maxRaw=parseFloat(q.max ?? '');
  const stepRaw=parseFloat(q.step ?? '');
  const min=Number.isFinite(minRaw)?minRaw:0;
  const max=Number.isFinite(maxRaw)?maxRaw:10;
  const step=Number.isFinite(stepRaw)?stepRaw:1;

  const storedRaw=surveyState.answers[q.id];
  let storedVal=null;
  if(storedRaw && typeof storedRaw==='object' && typeof storedRaw.value==='number') storedVal=storedRaw.value;
  else if(Number.isFinite(Number(storedRaw))) storedVal=Number(storedRaw);
  if(storedVal!==null && (storedVal<min || storedVal>max)) storedVal=null;

  const mid=Math.round((min+max)/2);
  const defaultVal=storedVal!==null?storedVal:(isNps?mid:min);
  const ratingLabels=q.scaleLabels || {};
  const describe=val=>{
    if(isNps) return `${val}`;
    if(isRating){
      const lbl=ratingLabels?.[val];
      return lbl ? `${lbl}` : `${val}`;
    }
    return `Score: ${val}/${max}`;
  };

  const input=document.createElement('input');
  input.type='range';
  input.min=String(min);
  input.max=String(max);
  input.step=String(step);

  let scoreEl=null;
  let scoreLabel=null;
  let sliderFill=null;
  let sliderThumb=null;
  let thumbValueEl=null;
  let laneEl=null;
  const markerSpans=[];
  const ratingTickEls=[];
  let bucketBox=null;
  const bucketAreas=[];
  let valueLabel=null;
  let sliderPlaceholder=null;

  if(isNps){
    const shell=document.createElement('div'); shell.className='nps-shell';

    const question=document.createElement('div'); question.className='nps-question';
    const prefix=Number.isFinite(displayIndex)?`<span class="nps-question-number">${displayIndex})</span>`:'';
    question.innerHTML=`${prefix} ${q.prompt}`;
    shell.appendChild(question);

    scoreEl=document.createElement('div'); scoreEl.className='nps-score';
    shell.appendChild(scoreEl);

    const sliderBlock=document.createElement('div'); sliderBlock.className='nps-slider';
    const track=document.createElement('div'); track.className='nps-slider-track';
    const lane=document.createElement('div'); lane.className='nps-slider-lane';
    laneEl=lane;
    sliderFill=document.createElement('div'); sliderFill.className='nps-slider-fill'; lane.appendChild(sliderFill);
    sliderThumb=document.createElement('div'); sliderThumb.className='nps-slider-thumb';
    const thumbImg=document.createElement('img'); thumbImg.src='./assets/img/ramen-icon.svg'; thumbImg.alt='Ramen icon';
    thumbValueEl=document.createElement('span'); thumbValueEl.className='thumb-value';
    sliderThumb.appendChild(thumbImg);
    sliderThumb.appendChild(thumbValueEl);
    lane.appendChild(sliderThumb);
    track.appendChild(lane);
    sliderBlock.appendChild(track);
    sliderBlock.appendChild(input);
    shell.appendChild(sliderBlock);

    const ticksWrap=document.createElement('div'); ticksWrap.className='nps-ticks';
    for(let v=min; v<=max; v+=step){
      const span=document.createElement('span'); span.textContent=String(v);
      markerSpans.push(span);
      ticksWrap.appendChild(span);
    }
    shell.appendChild(ticksWrap);

    if(Array.isArray(q.buckets) && q.buckets.length){
      bucketBox=document.createElement('div'); bucketBox.className='nps-followups';
      q.buckets.forEach(bucket=>{
        const area=document.createElement('div'); area.className='nps-followup';
        area.dataset.bucketId=bucket.id;
        const label=document.createElement('label'); label.setAttribute('for', bucket.id); label.textContent=bucket.label || 'Tell us more';
        const textarea=document.createElement('textarea'); textarea.id=bucket.id; textarea.placeholder=bucket.placeholder || 'Your feedback…';
        textarea.value = surveyState.answers[bucket.id] || '';
        textarea.addEventListener('input', ()=>{ surveyState.answers[bucket.id]=textarea.value; updateStepButtons(); });
        area.appendChild(label); area.appendChild(textarea);
        bucketAreas.push({bucket, area});
        bucketBox.appendChild(area);
      });
      shell.appendChild(bucketBox);
    }

    wrap.appendChild(shell);
  }else if(isRating){
    const shell=document.createElement('div'); shell.className='rating-shell';

    const question=document.createElement('h3'); question.className='rating-question';
    const questionNumber=Number.isFinite(displayIndex)?`<span class="rating-question-number">${displayIndex})</span>`:'';
    question.innerHTML=`${questionNumber} ${q.prompt}`;
    shell.appendChild(question);

    scoreEl=document.createElement('div'); scoreEl.className='rating-score';
    shell.appendChild(scoreEl);

    const sliderBlock=document.createElement('div'); sliderBlock.className='rating-slider';
    const track=document.createElement('div'); track.className='rating-slider-track';
    const lane=document.createElement('div'); lane.className='rating-slider-lane';
    laneEl=lane;
    sliderFill=document.createElement('div'); sliderFill.className='rating-slider-fill'; lane.appendChild(sliderFill);
    sliderThumb=document.createElement('div'); sliderThumb.className='rating-slider-thumb';
    const thumbImg=document.createElement('img'); thumbImg.src='./assets/img/ramen-icon.svg'; thumbImg.alt='Ramen icon';
    thumbValueEl=document.createElement('span'); thumbValueEl.className='thumb-value';
    sliderThumb.appendChild(thumbImg);
    sliderThumb.appendChild(thumbValueEl);
    lane.appendChild(sliderThumb);
    track.appendChild(lane);
    sliderBlock.appendChild(track);
    sliderBlock.appendChild(input);
    shell.appendChild(sliderBlock);

    const ticksWrap=document.createElement('div'); ticksWrap.className='rating-ticks';
    for(let v=min; v<=max; v+=step){
      const tick=document.createElement('span');
      const tickLabel=ratingLabels?.[v] || String(v);
      tick.textContent=tickLabel;
      ratingTickEls.push({value:v, el:tick});
      ticksWrap.appendChild(tick);
    }
    shell.appendChild(ticksWrap);

    if(Array.isArray(q.buckets) && q.buckets.length){
      bucketBox=document.createElement('div'); bucketBox.className='rating-followups';
      q.buckets.forEach(bucket=>{
        const area=document.createElement('div'); area.className='rating-followup';
        area.dataset.bucketId=bucket.id;
        const label=document.createElement('label'); label.setAttribute('for', bucket.id);
        const labelText=bucket.label || 'Tell us more';
        label.textContent=`${labelText} (optional)`;
        const textarea=document.createElement('textarea'); textarea.id=bucket.id; textarea.placeholder=bucket.placeholder || 'Your feedback…';
        textarea.value = surveyState.answers[bucket.id] || '';
        textarea.addEventListener('input', ()=>{ surveyState.answers[bucket.id]=textarea.value; updateStepButtons(); });
        area.appendChild(label); area.appendChild(textarea);
        bucketAreas.push({bucket, area});
        bucketBox.appendChild(area);
      });
      shell.appendChild(bucketBox);
    }

    wrap.appendChild(shell);
  }else{
    valueLabel=document.createElement('div'); valueLabel.className='slider-value';
    sliderPlaceholder=`Drag to choose (${min}-${max})`;
    if(storedVal===null){
      valueLabel.textContent=sliderPlaceholder;
      valueLabel.classList.add('placeholder');
    }else{
      valueLabel.textContent=describe(storedVal);
      valueLabel.classList.remove('placeholder');
    }
    wrap.appendChild(valueLabel);

    const trackContainer=document.createElement('div'); trackContainer.className='slider-track';
    trackContainer.appendChild(input);
    wrap.appendChild(trackContainer);

    const scale=document.createElement('div'); scale.className='slider-scale';
    const minSpan=document.createElement('span'); minSpan.textContent=q.labels?.min || String(min);
    const maxSpan=document.createElement('span'); maxSpan.textContent=q.labels?.max || String(max);
    scale.appendChild(minSpan); scale.appendChild(maxSpan);
    wrap.appendChild(scale);
  }

  const hasStored = storedVal!==null;
  const updateBuckets=(val,commit)=>{
    if(!bucketBox) return;
    let active=false;
    bucketAreas.forEach(({bucket, area})=>{
      const bucketMin=Number.isFinite(bucket.min)?bucket.min:min;
      const bucketMax=Number.isFinite(bucket.max)?bucket.max:max;
      const inRange=Number.isFinite(val) && val>=bucketMin && val<=bucketMax;
      const show = (commit || hasStored) && inRange;
      area.classList.toggle('is-visible', show);
      if(show) area.removeAttribute('aria-hidden');
      else area.setAttribute('aria-hidden','true');
      if(!show && commit) delete surveyState.answers[bucket.id];
      if(show) active=true;
    });
    bucketBox.classList.toggle('active', active);
  };

  const applyValue=(val,commit)=>{
    if(commit) surveyState.answers[q.id]={value:val};
    const safeVal = Number(val);
    const range = max>min ? max-min : 1;
    const ratioRaw = (safeVal - min)/range;
    const ratio = Number.isFinite(ratioRaw) ? Math.max(0, Math.min(1, ratioRaw)) : 0;
    const fillPct = ratio*100;
    let pct = ratio*100;
    if(laneEl && sliderThumb){
      const laneWidth = laneEl.clientWidth;
      const thumbWidth = sliderThumb.offsetWidth;
      if(laneWidth>0 && thumbWidth>0){
        const minCenter = thumbWidth/2;
        const maxCenter = laneWidth - thumbWidth/2;
        const rawCenter = ratio * laneWidth;
        const clampedCenter = Math.min(maxCenter, Math.max(minCenter, rawCenter));
        pct = (clampedCenter / laneWidth) * 100;
      }
    }
    input.value=String(val);
    input.style.setProperty('--pct', `${pct}%`);

    if(isNps){
      if(scoreEl) scoreEl.textContent=describe(val);
      if(sliderFill) sliderFill.style.width=`${fillPct}%`;
      if(sliderThumb) sliderThumb.style.left=`${pct}%`;
      if(thumbValueEl){
        thumbValueEl.textContent=String(val);
        thumbValueEl.classList.remove('is-empty');
      }
      markerSpans.forEach((el,i)=>{
        const markerVal=min + i*step;
        el.classList.toggle('active', Math.abs(markerVal-val)<0.001);
      });
    }else if(isRating){
      const answered=!!(surveyState.answers[q.id] && surveyState.answers[q.id].value!==undefined);
      const displayVal=answered?val:min;
      const desc=describe(displayVal);
      if(scoreEl){
        scoreEl.textContent=String(displayVal);
        scoreEl.classList.toggle('is-empty', !answered);
      }
      if(sliderFill) sliderFill.style.width=answered?`${fillPct}%`:'0%';
      if(sliderThumb) sliderThumb.style.left=`${pct}%`;
      if(thumbValueEl){
        thumbValueEl.textContent=String(displayVal);
        thumbValueEl.classList.toggle('is-empty', !answered);
      }
      ratingTickEls.forEach(({value, el})=>{
        el.classList.toggle('active', answered && Math.abs(value-val)<0.001);
      });
    }else if(valueLabel){
      if(commit){
        valueLabel.textContent=describe(val);
        valueLabel.classList.remove('placeholder');
      }else if(sliderPlaceholder){
        valueLabel.textContent=sliderPlaceholder;
        valueLabel.classList.add('placeholder');
      }
    }
    updateBuckets(val, commit);
    if(commit) updateStepButtons();
  };

  input.addEventListener('input', ()=>applyValue(Number(input.value), true));
  input.addEventListener('change', ()=>applyValue(Number(input.value), true));

  const initialVal=storedVal!==null?storedVal:defaultVal;
  applyValue(initialVal, storedVal!==null);

  if(storedVal===null){
    updateBuckets(initialVal, false);
  }

  return wrap;
}

function renderText(q){
  const box=document.createElement('div'); 
  const input=document.createElement('input'); input.type='text'; input.placeholder=q.placeholder||'Type here';
  input.value = surveyState.answers[q.id]||'';
  input.addEventListener('input', ()=>{ surveyState.answers[q.id]=input.value; updateStepButtons(); });
  box.appendChild(input);
  return box;
}

function renderQ(){
  surveyState.idx = nearestVisibleIndex(surveyState.idx);
  const q=QUESTIONS[surveyState.idx];
  if(!q || !isQuestionVisible(q)) return;
  const visible=visibleQuestions();
  const position=Math.max(visible.findIndex(item=>item.id===q.id),0);
  qwrap.innerHTML='';
  const card=document.createElement('div'); card.className='cardQ';
  const isNps = q.theme==='nps';
  const isRating = q.theme==='rating';
  if(isNps) card.classList.add('card-nps');
  if(isRating) card.classList.add('card-rating');
  const num=document.createElement('div'); num.className='qnum'; num.textContent=`Question ${position+1}`;
  if(isNps || isRating) num.style.display='none';
  const title=document.createElement('h3'); title.className='qtitle'; title.textContent=q.prompt;
  card.appendChild(num); card.appendChild(title);
  if(isNps || isRating) title.style.display='none';

  if(q.type==='buttons'){ card.appendChild(renderButtons(q)); }
  else if(q.type==='text'){ card.appendChild(renderText(q)); }
  else if(q.type==='slider'){ card.appendChild(renderSlider(q, position+1)); }
  qwrap.appendChild(card);
  updateStepButtons();
}
function goNextOrSubmit(){
  const nextIdx = findNextVisibleIndex(surveyState.idx, 1);
  if(nextIdx >=0 && nextIdx < QUESTIONS.length){
    surveyState.idx = nextIdx;
    renderQ();
  }else if(validStep()){
    submitBtn.click();
  }
}

/* ---------- Gate submit ---------- */
gateForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(continueBtn.disabled) return;
  overlay.classList.add('show');

  let gateRowId = null;
  try{
    if(sb){
      const { data, error } = await sb.from('submissions').insert([{
        brand:'Mendokoro/Yushoken', flow:'with_receipt', has_receipt:true,
        receipt_no:receiptEl.value.trim(), email:emailEl.value.trim(), name:nameEl.value.trim()||null,
        consent:dpaEl.checked, subscribed:promoEl.checked
      }]).select().single();
      if(error) throw error;
      gateRowId = data?.id || null;
    }
  }catch(err){ console.warn('Gate save skipped/failed:', err?.message); }

  setTimeout(()=>{
    overlay.classList.remove('show');
    stepGate.style.display='none';
    stepSurvey.style.display='block';
    surveyState.idx=0; surveyState.answers={};
    renderQ(); setProgress();
    stepSurvey.dataset.gateId = gateRowId || '';
  }, 600);
});

/* Navigation */
backBtn.onclick=()=>{
  const prevIdx = findNextVisibleIndex(surveyState.idx, -1);
  if(prevIdx>=0){
    surveyState.idx = prevIdx;
    renderQ();
  }else{
    stepSurvey.style.display='none';
    stepGate.style.display='block';
  }
};
nextBtn.onclick=()=>{ if(validStep()) goNextOrSubmit(); };

/* Submit survey */
function rewardCode(prefix="MDG"){
  const chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"; let c="";
  for(let i=0;i<6;i++) c+=chars[Math.floor(Math.random()*36)];
  return `${prefix}-${c}`;
}
submitBtn.onclick=async()=>{
  if(!validStep()) return;
  submitBtn.disabled=true; submitBtn.textContent='Submitting…';
  try{
    const code=rewardCode('MDG'); 
    document.getElementById('rewardCode').textContent=code;

    // push suggestion history
    pushHistory('cities', (surveyState.answers['q4_city']||'').trim());
    pushHistory('malls', (surveyState.answers['q4_mall']||'').trim());
    pushHistory('places', (surveyState.answers['q5_place']||'').trim());
    pushHistory('sources', (surveyState.answers['q2_other']||'').trim());

    const answersClean = normalizeAnswers(surveyState.answers);

    if(sb){
      const gateId = stepSurvey.dataset.gateId || null;
      const payload = { answers:answersClean, reward_code:code, ...answersClean };
      if(gateId){
        await sb.from('submissions').update(payload).eq('id', gateId);
      }else{
        await sb.from('submissions').insert([{
          brand:'Mendokoro/Yushoken', flow:'with_receipt', has_receipt:true,
          receipt_no:receiptEl.value.trim(), email:emailEl.value.trim(), name:nameEl.value.trim()||null,
          consent:dpaEl.checked, subscribed:promoEl.checked, ...payload
        }]);
      }
    }

    stepSurvey.style.display='none'; 
    stepReward.style.display='block';
  }catch(e){
    alert('Error saving. Please try again.');
    submitBtn.disabled=false; submitBtn.textContent='Submit →';
  }
};

/* Copy + Save coupon */
document.getElementById('copyBtn').onclick=async()=>{
  try{ await navigator.clipboard.writeText(document.getElementById('rewardCode').textContent); }catch{}
};
document.getElementById('saveImgBtn').onclick=()=> exportCoupon();

/* Export coupon as PNG (teal glow) */
async function exportCoupon(){
  const canvas=document.getElementById('couponCanvas');
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,W,H);

  const grd=ctx.createRadialGradient(160,140,40,160,140,240);
  grd.addColorStop(0,'rgba(14,155,164,0.20)'); grd.addColorStop(1,'rgba(14,155,164,0)');
  ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(170,150,180,0,Math.PI*2); ctx.fill();
  const grd2=ctx.createRadialGradient(W-160,H-160,40,W-160,H-160,260);
  grd2.addColorStop(0,'rgba(14,155,164,0.20)'); grd2.addColorStop(1,'rgba(14,155,164,0)');
  ctx.fillStyle=grd2; ctx.beginPath(); ctx.arc(W-170,H-170,200,0,Math.PI*2); ctx.fill();

  roundedRect(ctx, 36,36, W-72, H-72, 34);
  ctx.save(); ctx.strokeStyle='rgba(14,155,164,1)'; ctx.lineWidth=6; ctx.setLineDash([18,14]); ctx.stroke(); ctx.restore();

  ctx.save(); ctx.globalCompositeOperation='destination-out';
  drawCircle(ctx, 36, H/2, 26); drawCircle(ctx, W-36, H/2, 26);
  ctx.restore();

  const logo = await loadImage('./assets/img/mendokorologo.png').catch(()=>null);
  if(logo){ const lw=260, lh=260*logo.height/logo.width; ctx.drawImage(logo, W/2 - lw/2, 80, lw, lh); }

  const gyoza = await loadImage('./assets/img/gyoza.png').catch(()=>null);
  if(gyoza){
    const gw = 360, gh = 360*gyoza.height/gyoza.width;
    ctx.save(); ctx.globalAlpha = 0.15;
    ctx.drawImage(gyoza, W-80-gw, 70, gw, gh);
    ctx.restore();
  }

  ctx.fillStyle='#151515'; ctx.textAlign='center';
  ctx.font='800 46px Montserrat, sans-serif'; ctx.fillText('FREE 3 PIECE GYOZA FROM US!', W/2, 360);
  ctx.font='700 20px Montserrat, sans-serif'; ctx.fillStyle='#6b7280';
  ctx.fillText('Show this at the truck to redeem • One-time use', W/2, 394);

  const code=document.getElementById('rewardCode').textContent || 'MDG-XXXXXX';
  const pillW = Math.max(380, ctx.measureText(code).width + 80);
  const pillX=W/2 - pillW/2, pillY=420, pillH=78, r=18;
  ctx.fillStyle='#e7fbfd'; roundedRect(ctx, pillX, pillY, pillW, pillH, r); ctx.fill();
  ctx.save(); ctx.setLineDash([12,10]); ctx.lineWidth=3; ctx.strokeStyle='rgba(14,155,164,1)'; roundedRect(ctx, pillX, pillY, pillW, pillH, r); ctx.stroke(); ctx.restore();
  ctx.font='800 36px Montserrat, sans-serif'; ctx.fillStyle='#151515'; ctx.fillText(code, W/2, pillY+50);

  const url=canvas.toDataURL('image/png');
  const a=document.createElement('a');
  a.href=url; a.download=`mendokoro-coupon-${code}.png`;
  document.body.appendChild(a); a.click(); a.remove();
}

function roundedRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}
function drawCircle(ctx,x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
function loadImage(src){
  return new Promise((res,rej)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>res(im); im.onerror=rej; im.src=src; });
}

/* Hook typeahead to followups when rendered */
const origRenderButtons = renderButtons;
</script>
</body>
</html>
